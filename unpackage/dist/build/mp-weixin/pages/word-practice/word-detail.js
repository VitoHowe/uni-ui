"use strict";const e=require("../../common/vendor.js"),o=require("../../stores/wordPractice.js");if(!Array){e.resolveComponent("uni-icons")()}Math||(r+t+(()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+n+a)();const r=()=>"../../components/word-practice/WordPracticeHeader.js",t=()=>"../../components/word-practice/WordPracticePanel.js",n=()=>"../../components/word-practice/WordListTable.js",a=()=>"../../components/word-practice/WordBookSelector.js",l={__name:"word-detail",setup(r){const t=o.useWordPracticeStore(),n=e.ref(""),a=e.ref(1),l=e.ref(!1),d=e.ref(!1),u=e.reactive({loading:!1,error:""});let c=null;const s=()=>{c&&(c.stop(),c.destroy(),c=null)},i=e.computed((()=>{const e=n.value.trim().toLowerCase();return e?t.currentWords.filter((o=>{var r,t;return(null==(r=o.english)?void 0:r.toLowerCase().includes(e))||(null==(t=o.chinese)?void 0:t.includes(e))})):t.currentWords})),v=e.computed((()=>Math.max(1,Math.ceil(i.value.length/30)))),p=e.computed((()=>{const e=30*(a.value-1);return i.value.slice(e,e+30)})),f=e.computed((()=>[{label:"词汇总数",value:t.currentWords.length},{label:"已掌握",value:t.mastered.length},{label:"收藏",value:t.favorites.length}])),m=e.computed((()=>t.currentWord&&t.favorites.includes(t.currentWord.id))),g=e.computed((()=>{var e;const o=null==(e=t.currentWord)?void 0:e.id;return o?t.mastered.includes(o)?"已掌握":t.mistakes.includes(o)?"待复习":"未学习":"未学习"})),h=e.computed((()=>{var e;if(!t.currentWords.length)return"--";const o=(t.currentWordIndex+1)%t.currentWords.length;return(null==(e=t.currentWords[o])?void 0:e.english)||"--"})),W=e.computed((()=>[{type:"random",name:"随机练习",desc:"打破顺序",count:"",icon:"loop",bg:"linear-gradient(135deg, #4f46e5, #7c3aed)"},{type:"favorites",name:"收藏夹",desc:"高频复习",count:t.favorites.length,icon:"star",bg:"linear-gradient(135deg, #f59e0b, #f97316)"},{type:"mistakes",name:"错词集",desc:"重新巩固",count:t.mistakes.length,icon:"closeempty",bg:"linear-gradient(135deg, #fb7185, #f43f5e)"}])),k=e=>{var o;return e?{...e,bookName:e.bookName||(null==(o=t.currentBook)?void 0:o.name)||"未知词书"}:null},w=e.computed((()=>{const e=new Map(t.currentWords.map((e=>[e.id,k(e)])));return t.favorites.map((o=>e.get(o))).filter(Boolean)})),b=e.computed((()=>{const e=new Map(t.currentWords.map((e=>[e.id,k(e)])));return t.mistakes.map((o=>e.get(o))).filter(Boolean)})),x=()=>{a.value=1},y=()=>{n.value=""};e.watch(n,(()=>{a.value=1}));const I=e=>{"prev"===e&&a.value>1&&(a.value-=1),"next"===e&&a.value<v.value&&(a.value+=1)},B=()=>{if(!i.value.length)return;const e=i.value[Math.floor(Math.random()*i.value.length)];M(e)},M=e=>{e&&(t.jumpToWord(e.id),C(e.id))},C=e=>{const o=i.value.findIndex((o=>o.id===e));-1!==o&&(a.value=Math.floor(o/30)+1)},j=o=>{t.currentWord&&("mastered"===o?(t.markMastered(t.currentWord.id),e.index.showToast({title:"已标记为掌握",icon:"none"})):(t.markMistake(t.currentWord.id),e.index.showToast({title:"已加入错词",icon:"none"})),t.setCurrentWordIndex(t.currentWordIndex+1))},T=()=>{if(!t.currentWord)return;const o=t.favorites.includes(t.currentWord.id);t.toggleFavorite(t.currentWord.id),e.index.showToast({title:o?"已移出收藏":"已加入收藏",icon:"none"})},L=async e=>{e&&(await t.selectBook(e.id),l.value=!1,n.value="")},_=()=>{if(t.currentWord)if(e.index.createInnerAudioContext){u.loading=!0,u.error="";try{if(A(),!c)return void(u.error="发音组件初始化失败");const e=t.currentWord.english||t.currentWord.word||"",r=((o=e)?o.replace(/\([^)]*\)/g," ").replace(/[^a-zA-Z0-9\s-]/g," ").replace(/\s+/g," ").trim():"")||e;c.stop(),c.src=`https://dict.youdao.com/dictvoice?type=2&audio=${encodeURIComponent(r)}`,c.play()}catch(r){console.error("播放发音出错",r),u.error="发音服务异常，请稍后再试",s()}finally{u.loading=!1}var o}else e.index.showToast({title:"当前环境不支持发音",icon:"none"})},A=()=>{!c&&e.index.createInnerAudioContext&&(c=e.index.createInnerAudioContext(),c.obeyMuteSwitch=!1,c.onStop((()=>{u.error=""})),c.onError((e=>{console.error("发音播放失败",e),u.error="无法获取发音，请稍后重试",u.loading=!1,s()})))};return e.watch(i,(()=>{30*(a.value-1)>=i.value.length&&(a.value=1)})),e.watch((()=>t.selectedBookId),(()=>{a.value=1,n.value=""})),e.onLoad((e=>{(async e=>{if(!d.value){d.value=!0;try{t.books.length||await t.loadBooks(),e?await t.selectBook(e):!t.selectedBookId&&t.books.length&&await t.selectBook(t.books[0].id),t.selectedBookId&&!t.currentWords.length&&await t.loadWords(t.selectedBookId)}finally{d.value=!1}}})(null==e?void 0:e.bookId)})),e.onMounted((()=>{A()})),e.onUnmounted((()=>{s()})),(o,r)=>e.e({a:e.o((e=>l.value=!0)),b:e.p({book:e.unref(t).currentBook,"learning-rate":e.unref(t).learningRate,stats:f.value,loading:e.unref(t).wordsLoading||e.unref(t).booksLoading}),c:e.o(_),d:e.o(T),e:e.o((e=>j("mastered"))),f:e.o((e=>j("mistake"))),g:e.o((o=>e.unref(t).setCurrentWordIndex(e.unref(t).currentWordIndex+1))),h:e.o((o=>e.unref(t).setCurrentWordIndex(e.unref(t).currentWordIndex-1))),i:e.p({word:e.unref(t).currentWord,index:e.unref(t).currentWordIndex,total:e.unref(t).currentWords.length,"mastery-label":g.value,"is-favorite":m.value,"next-preview":h.value,"pronunciation-state":u}),j:e.p({type:"search",size:"18",color:"#94a3b8"}),k:e.o(x),l:n.value,m:e.o((e=>n.value=e.detail.value)),n:n.value},n.value?{o:e.p({type:"closeempty",size:"16",color:"#94a3b8"}),p:e.o(y)}:{},{q:e.t(i.value.length),r:e.t(a.value),s:e.t(v.value),t:e.o(B),v:e.f(W.value,((o,r,t)=>({a:"978f9852-4-"+t,b:e.p({type:o.icon,size:"18",color:"#fff"}),c:e.t(o.name),d:e.t(o.desc),e:e.t(o.count),f:o.type,g:o.bg,h:e.o((r=>(o=>{switch(o.type){case"random":B();break;case"favorites":w.value.length?M(w.value[0]):e.index.showToast({title:"暂无收藏",icon:"none"});break;case"mistakes":b.value.length?M(b.value[0]):e.index.showToast({title:"暂无错词",icon:"none"})}})(o)),o.type)}))),w:e.o(I),x:e.o(M),y:e.p({words:p.value,"current-page":a.value,"total-pages":v.value}),z:e.o((e=>l.value=!1)),A:e.o(L),B:e.p({visible:l.value,books:e.unref(t).books,"selected-book-id":e.unref(t).selectedBookId,loading:e.unref(t).booksLoading})})}},d=e._export_sfc(l,[["__scopeId","data-v-978f9852"]]);wx.createPage(d);
