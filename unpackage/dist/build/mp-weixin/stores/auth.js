"use strict";const e=require("../common/vendor.js"),o=require("../utils/request.js"),t=require("../utils/constants.js"),n=require("../utils/auth.js"),s=e.defineStore("auth",{state:()=>({isLoggedIn:!1,user:null,loading:{login:!1,refresh:!1,profile:!1},tokenInfo:{hasToken:!1,expiresAt:null}}),getters:{isAuthenticated:e=>e.isLoggedIn&&e.user&&n.TokenManager.getAccessToken(),userNickname:e=>{var o;return(null==(o=e.user)?void 0:o.nickname)||"ç”¨æˆ·"},userAvatar:e=>{var o;return(null==(o=e.user)?void 0:o.avatar_url)||"/static/uni.png"},isAdmin:e=>{var o;return 1===(null==(o=e.user)?void 0:o.role_id)},userRoleText:e=>e.user?1===e.user.role_id?"ç®¡ç†å‘˜":"æ™®é€šç”¨æˆ·":"æœªç™»å½•",loginStatusText:e=>e.loading.login?"ç™»å½•ä¸­...":e.loading.refresh?"åˆ·æ–°ä¸­...":e.isLoggedIn?"å·²ç™»å½•":"æœªç™»å½•",tokenWillExpire:()=>n.TokenManager.shouldRefreshToken()},actions:{async initAuthState(){try{console.log("ğŸš€ åˆå§‹åŒ–è®¤è¯çŠ¶æ€");const o=n.LoginStateManager.getLoginState(),t=n.UserManager.getUserInfo(),s=!!n.TokenManager.getAccessToken();if(o&&t&&s)n.TokenManager.isTokenExpired()?(console.log("âš ï¸ Tokenå·²è¿‡æœŸï¼Œå°è¯•åˆ·æ–°"),await this.refreshToken()):(this.isLoggedIn=!0,this.user=t,this.updateTokenInfo(),console.log("âœ… ç™»å½•çŠ¶æ€å·²æ¢å¤",t));else{this.clearAuthData();const o=getCurrentPages();if(o.length>0){const t=o[o.length-1];"/pages/login/login"!==`/${t.route}`&&(console.log("ğŸšª ç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢"),e.index.reLaunch({url:"/pages/login/login"}))}}}catch(o){console.error("âŒ åˆå§‹åŒ–è®¤è¯çŠ¶æ€å¤±è´¥:",o),this.logout(!1)}},async loginWithWechat(e=!1,s=!1){if(this.loading.login)throw new Error("æ­£åœ¨ç™»å½•ä¸­ï¼Œè¯·ç¨å€™...");try{if(this.loading.login=!0,console.log("ğŸ” å¼€å§‹å¾®ä¿¡ç™»å½•",{requireUserInfo:e,isRetry:s}),!n.WechatAuth.isWechatLoginSupported())throw new Error("å½“å‰ç¯å¢ƒä¸æ”¯æŒå¾®ä¿¡ç™»å½•");const i=await n.WechatAuth.getWechatCode(s);console.log("ğŸ“ å‡†å¤‡ç™»å½•æ•°æ®",{codePrefix:i.substring(0,8)+"...",requireUserInfo:e,timestamp:(new Date).toLocaleTimeString()});const a={code:i};if(e)try{const e=await n.WechatAuth.getUserProfile();Object.assign(a,{encryptedData:e.encryptedData,iv:e.iv,signature:e.signature}),console.log("ğŸ‘¤ å·²è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå‡†å¤‡å®Œæ•´ç™»å½•")}catch(r){console.warn("âš ï¸ ç”¨æˆ·å–æ¶ˆæˆæƒï¼Œä»…è¿›è¡ŒåŸºç¡€ç™»å½•")}const l=await o.request.post(t.API_ENDPOINTS.AUTH.LOGIN,a,{needAuth:!1,showLoading:!1});return this.saveAuthData(l),console.log("âœ… å¾®ä¿¡ç™»å½•æˆåŠŸ"),!0}catch(i){if(console.error("âŒ å¾®ä¿¡ç™»å½•å¤±è´¥:",i),n.WechatAuth.clearCodeCache(),this.isCodeRelatedError(i)&&(console.log("ğŸ”„ æ£€æµ‹åˆ°codeç›¸å…³é”™è¯¯ï¼Œå‡†å¤‡é‡è¯•"),!s))return console.log("ğŸ”„ è‡ªåŠ¨é‡è¯•ç™»å½•ï¼ˆä½¿ç”¨æ–°codeï¼‰"),await this.delay(1e3),await this.loginWithWechat(e,!0);throw i}finally{this.loading.login=!1}},isCodeRelatedError(e){var o;const t=(null==(o=e.message)?void 0:o.toLowerCase())||"";return t.includes("code")&&(t.includes("been used")||t.includes("invalid")||t.includes("expired"))},delay:e=>new Promise((o=>setTimeout(o,e))),async refreshToken(){if(this.loading.refresh)return;const e=n.TokenManager.getRefreshToken();if(!e)throw new Error("æ²¡æœ‰åˆ·æ–°ä»¤ç‰Œï¼Œè¯·é‡æ–°ç™»å½•");try{this.loading.refresh=!0,console.log("ğŸ”„ åˆ·æ–°Token");const s=await o.request.post(t.API_ENDPOINTS.AUTH.REFRESH,{refreshToken:e},{needAuth:!1,showLoading:!1});n.TokenManager.setTokens(s),this.updateTokenInfo(),console.log("âœ… Tokenåˆ·æ–°æˆåŠŸ")}catch(s){throw console.error("âŒ Tokenåˆ·æ–°å¤±è´¥:",s),this.logout(!1),s}finally{this.loading.refresh=!1}},async getUserProfile(){if(!this.isAuthenticated)throw new Error("ç”¨æˆ·æœªç™»å½•");try{this.loading.profile=!0,console.log("ğŸ‘¤ è·å–ç”¨æˆ·èµ„æ–™");const e=await o.request.get(t.API_ENDPOINTS.AUTH.PROFILE);this.user=e,n.UserManager.setUserInfo(e),console.log("âœ… ç”¨æˆ·èµ„æ–™è·å–æˆåŠŸ")}catch(e){throw console.error("âŒ è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥:",e),e}finally{this.loading.profile=!1}},async logout(n=!0){try{if(console.log("ğŸšª ç”¨æˆ·é€€å‡ºç™»å½•"),n&&this.isAuthenticated)try{await o.request.post(t.API_ENDPOINTS.AUTH.LOGOUT)}catch(s){console.warn("âš ï¸ è°ƒç”¨ç™»å‡ºAPIå¤±è´¥ï¼Œç»§ç»­æœ¬åœ°ç™»å‡º",s)}this.clearAuthData(),e.index.reLaunch({url:"/pages/login/login"}),e.index.showToast({title:"å·²é€€å‡ºç™»å½•",icon:"success"})}catch(r){console.error("âŒ é€€å‡ºç™»å½•è¿‡ç¨‹å‡ºé”™:",r)}},checkAuthStatus(){const e=!!n.TokenManager.getAccessToken(),o=n.TokenManager.isTokenExpired(),t=!!this.user,s=this.isLoggedIn,r=e&&!o&&t&&s;return this.isLoggedIn!==r&&(this.isLoggedIn=r,r||this.clearAuthData()),r},saveAuthData(e){const{accessToken:o,refreshToken:t,expiresIn:s,user:r}=e;n.TokenManager.setTokens({accessToken:o,refreshToken:t,expiresIn:s}),n.UserManager.setUserInfo(r),n.LoginStateManager.setLoginState(!0),this.isLoggedIn=!0,this.user=r,this.updateTokenInfo(),console.log("ğŸ’¾ è®¤è¯æ•°æ®å·²ä¿å­˜")},clearAuthData(){n.TokenManager.clearTokens(),n.UserManager.clearUserInfo(),n.LoginStateManager.clearLoginState(),this.isLoggedIn=!1,this.user=null,this.tokenInfo={hasToken:!1,expiresAt:null},console.log("ğŸ—‘ï¸ è®¤è¯æ•°æ®å·²æ¸…é™¤")},updateTokenInfo(){const o=!!n.TokenManager.getAccessToken(),t=e.index.getStorageSync("token_expires_at");this.tokenInfo={hasToken:o,expiresAt:t}},async forceRefreshUser(){if(this.isAuthenticated)try{await this.getUserProfile()}catch(e){console.warn("âš ï¸ å¼ºåˆ¶åˆ·æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",e)}}}});exports.useAuthStore=s;
