"use strict";const o=require("../common/vendor.js"),s=require("../services/wordBooks.js"),r=require("../utils/wordProgress.js"),t=o=>null==o?null:String(o),e=(o,s)=>t(o)===t(s),i=o.defineStore("wordPractice",{state:()=>({books:[],booksTotal:0,booksPagination:null,booksLoading:!1,booksError:"",wordsLoading:!1,wordsError:"",wordsByBook:{},selectedBookId:o.index.getStorageSync("WORD_PRACTICE_LAST_BOOK")||null,currentWordIndex:0,progressByBook:{}}),getters:{currentBook:o=>o.books.find((s=>e(s.id,o.selectedBookId)))||null,currentWords:o=>o.wordsByBook[o.selectedBookId]||[],currentWord(o){const s=this.currentWords;if(!s.length)return null;return s[Math.min(Math.max(o.currentWordIndex,0),s.length-1)]||null},currentProgress:o=>o.progressByBook[o.selectedBookId]||r.createEmptyProgress(),favorites(){return this.currentProgress.favorites},mistakes(){return this.currentProgress.mistakes},mastered(){return this.currentProgress.mastered},learningRate(){const o=this.currentWords.length||1;return Math.round(this.mastered.length/o*100)}},actions:{async loadBooks(o={}){this.booksLoading=!0,this.booksError="";try{const{books:r,total:t,pagination:i}=await s.fetchWordBooks(o);this.books=r,this.booksTotal=t,this.booksPagination=i;const d=this.selectedBookId?r.find((o=>e(o.id,this.selectedBookId))):null;d?(this.selectedBookId=d.id,this.bootstrapProgress(d.id)):r.length&&await this.selectBook(r[0].id,{preloadWords:!1})}catch(r){console.error("获取单词书列表失败",r),this.booksError=r.message||"获取单词书失败"}finally{this.booksLoading=!1}},async selectBook(s,r={}){const{preloadWords:t=!0}=r;if(!s)return;const i=this.books.find((o=>e(o.id,s))),d=i?i.id:s,n=!e(this.selectedBookId,d);if(this.selectedBookId=d,o.index.setStorageSync("WORD_PRACTICE_LAST_BOOK",d),this.bootstrapProgress(d),!t||!n&&this.wordsByBook[d])if(t){const o=this.progressByBook[d];this.currentWordIndex=(null==o?void 0:o.lastCursor)||0}else{const o=this.progressByBook[d];this.currentWordIndex=(null==o?void 0:o.lastCursor)||0}else await this.loadWords(d)},async loadWords(o){const r=o||this.selectedBookId;if(r){this.wordsLoading=!0,this.wordsError="";try{const{words:o}=await s.fetchWordBookWords(r);this.wordsByBook={...this.wordsByBook,[r]:o},this.bootstrapProgress(r);const t=this.progressByBook[r];this.currentWordIndex=Math.min(t.lastCursor||0,Math.max(o.length-1,0))}catch(t){console.error("加载单词列表失败",t),this.wordsError=t.message||"加载单词失败"}finally{this.wordsLoading=!1}}},bootstrapProgress(o){o&&!this.progressByBook[o]&&(this.progressByBook={...this.progressByBook,[o]:r.readBookProgress(o)})},persistProgress(o){const s=o||this.selectedBookId,t=this.progressByBook[s];s&&t&&r.persistBookProgress(s,t)},setCurrentWordIndex(o){const s=this.currentWords;if(!s.length)return;const t=(o+s.length)%s.length;this.currentWordIndex=t;const e=r.updateCursor(this.currentProgress,t);this.progressByBook={...this.progressByBook,[this.selectedBookId]:e},this.persistProgress(this.selectedBookId)},jumpToWord(o){const s=this.currentWords.findIndex((s=>s.id===o));-1!==s&&this.setCurrentWordIndex(s)},toggleFavorite(o){if(!this.currentWord)return;const s=this.currentProgress.favorites.includes(o)?null:"favorite";this.applyWordStatus(o,s)},markMastered(o){this.applyWordStatus(o,"mastered")},markMistake(o){this.applyWordStatus(o,"mistake")},applyWordStatus(o,s){if(!this.selectedBookId||!o)return;let t=this.currentProgress;t=s?r.updateWordStatus(t,o,s):r.updateWordStatus(t,o),this.progressByBook={...this.progressByBook,[this.selectedBookId]:t},this.persistProgress(this.selectedBookId)}}});exports.useWordPracticeStore=i;
