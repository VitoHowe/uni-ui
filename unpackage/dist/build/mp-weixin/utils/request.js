"use strict";const e=require("../common/vendor.js"),r=require("./constants.js"),t=require("./auth.js");const s=new class{constructor(){this.pendingRequests=new Map,this.refreshingToken=!1,this.refreshPromise=null}async request(r){const{url:t,method:s="GET",data:o={},header:n={},needAuth:a=!0,showLoading:i=!0,retryCount:h=0}=r;i&&e.index.showLoading({title:"Âä†ËΩΩ‰∏≠...",mask:!0});try{const r=this.buildFullUrl(t),h=await this.buildHeaders(n,a),T=await this.performRequest({url:r,method:s.toUpperCase(),data:o,header:h});return await this.handleResponse(T)}catch(T){return await this.handleError(T,r,h)}finally{i&&e.index.hideLoading()}}get(e,r={},t={}){const s=this.buildQueryString(r),o=s?`${e}?${s}`:e;return this.request({url:o,method:"GET",...t})}post(e,r={},t={}){return this.request({url:e,method:"POST",data:r,...t})}put(e,r={},t={}){return this.request({url:e,method:"PUT",data:r,...t})}delete(e,r={}){return this.request({url:e,method:"DELETE",...r})}async upload(t,s,o={},n={}){const{needAuth:a=!0,showProgress:i=!0}=n;try{const n=this.buildFullUrl(t),h=await this.buildHeaders({},a);return console.log(n,s,o,"header",h),new Promise(((t,a)=>{const T=e.index.uploadFile({url:n,filePath:s,name:"file",formData:o,header:h,success:e=>{try{const s=JSON.parse(e.data);s.code===r.HTTP_STATUS.OK?t(s.data):a(new Error(s.message||"‰∏ä‰º†Â§±Ë¥•"))}catch(s){a(new Error("ÂìçÂ∫îÊï∞ÊçÆËß£ÊûêÂ§±Ë¥•"))}},fail:e=>{a(new Error(e.errMsg||"‰∏ä‰º†Â§±Ë¥•"))}});i&&T.onProgressUpdate((e=>{console.log("‰∏ä‰º†ËøõÂ∫¶:",e.progress+"%")}))}))}catch(h){throw this.createError("‰∏ä‰º†Â§±Ë¥•",r.ERROR_TYPES.NETWORK_ERROR)}}buildFullUrl(e){return e.startsWith("http")?e:`${r.API_CONFIG.BASE_URL}${e}`}buildQueryString(e){const r=[];for(const[t,s]of Object.entries(e))null!=s&&""!==s&&r.push(`${encodeURIComponent(t)}=${encodeURIComponent(s)}`);return r.join("&")}async buildHeaders(e={},r=!0){const s={"Content-Type":"application/json",...e};if(r){const e=t.TokenManager.getAccessToken();if(e&&(s.Authorization=`Bearer ${e}`),t.TokenManager.shouldRefreshToken()){await this.refreshTokenIfNeeded();const e=t.TokenManager.getAccessToken();e&&(s.Authorization=`Bearer ${e}`)}}return s}performRequest(t){return new Promise(((s,o)=>{e.index.request({...t,timeout:r.API_CONFIG.TIMEOUT,success:s,fail:o})}))}async handleResponse(e){const{statusCode:t,data:s}=e;if(console.log("üì° APIÂìçÂ∫î:",{statusCode:t,data:s}),t!==r.HTTP_STATUS.OK)throw this.createHttpError(t,s);if(s.code!==r.HTTP_STATUS.OK){if(s.code===r.HTTP_STATUS.UNAUTHORIZED)throw await this.handleAuthError(),this.createError(s.message||"ËÆ§ËØÅÂ§±Ë¥•",r.ERROR_TYPES.AUTH_ERROR);throw this.createError(s.message||"ËØ∑Ê±ÇÂ§±Ë¥•",r.ERROR_TYPES.BUSINESS_ERROR)}return s.data}async handleError(e,t,s){if(console.error("‚ùå ËØ∑Ê±ÇÂ§±Ë¥•:",e),this.isNetworkError(e)&&s<r.API_CONFIG.MAX_RETRY_COUNT)return console.log(`üîÑ ÁΩëÁªúÈîôËØØÔºåÂáÜÂ§áÈáçËØï (${s+1}/${r.API_CONFIG.MAX_RETRY_COUNT})`),await this.delay(1e3*(s+1)),this.request({...t,retryCount:s+1});if(this.isAuthError(e))try{return await this.refreshTokenAndRetry(),this.request(t)}catch(o){throw await this.handleAuthError(),this.createError("ËÆ§ËØÅÂ§±Ë¥•ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï",r.ERROR_TYPES.AUTH_ERROR)}throw this.createRequestError(e)}async refreshTokenIfNeeded(){if(t.TokenManager.shouldRefreshToken())if(this.refreshingToken)await this.refreshPromise;else try{this.refreshingToken=!0,this.refreshPromise=this.refreshToken(),await this.refreshPromise}finally{this.refreshingToken=!1,this.refreshPromise=null}}async refreshToken(){const e=t.TokenManager.getRefreshToken();if(!e)throw new Error("Ê≤°ÊúâÂà∑Êñ∞‰ª§Áâå");try{console.log("üîÑ ÂºÄÂßãÂà∑Êñ∞Token");const s=await this.performRequest({url:this.buildFullUrl(r.API_ENDPOINTS.AUTH.REFRESH),method:"POST",data:{refreshToken:e},header:{"Content-Type":"application/json"}}),o=await this.handleResponse(s);t.TokenManager.setTokens(o),console.log("‚úÖ TokenÂà∑Êñ∞ÊàêÂäü")}catch(s){throw console.error("‚ùå TokenÂà∑Êñ∞Â§±Ë¥•:",s),s}}async refreshTokenAndRetry(){await this.refreshToken()}async handleAuthError(){console.log("üîê ËÆ§ËØÅÂ§±Ë¥•ÔºåÊ∏ÖÈô§ÁôªÂΩïÁä∂ÊÄÅ"),t.LoginStateManager.logout(),e.index.reLaunch({url:"/pages/login/login"})}createHttpError(e,t){let s="ËØ∑Ê±ÇÂ§±Ë¥•",o=r.ERROR_TYPES.NETWORK_ERROR;switch(e){case r.HTTP_STATUS.BAD_REQUEST:s="ËØ∑Ê±ÇÂèÇÊï∞ÈîôËØØ";break;case r.HTTP_STATUS.UNAUTHORIZED:s="ËÆ§ËØÅÂ§±Ë¥•",o=r.ERROR_TYPES.AUTH_ERROR;break;case r.HTTP_STATUS.FORBIDDEN:s="ÊùÉÈôê‰∏çË∂≥",o=r.ERROR_TYPES.AUTH_ERROR;break;case r.HTTP_STATUS.NOT_FOUND:s="ËØ∑Ê±ÇÁöÑËµÑÊ∫ê‰∏çÂ≠òÂú®";break;case r.HTTP_STATUS.INTERNAL_SERVER_ERROR:s="ÊúçÂä°Âô®ÂÜÖÈÉ®ÈîôËØØ";break;default:s=`ËØ∑Ê±ÇÂ§±Ë¥• (${e})`}return this.createError((null==t?void 0:t.message)||s,o)}createRequestError(e){if(e.type)return e;let t="ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•",s=r.ERROR_TYPES.NETWORK_ERROR;return e.errMsg&&(e.errMsg.includes("timeout")?(t="ËØ∑Ê±ÇË∂ÖÊó∂ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•",s=r.ERROR_TYPES.TIMEOUT_ERROR):e.errMsg.includes("fail")&&(t="ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËÆæÁΩÆ")),this.createError(t,s)}createError(e,r){const t=new Error(e);return t.type=r,t}isNetworkError(e){return e.type===r.ERROR_TYPES.NETWORK_ERROR||e.type===r.ERROR_TYPES.TIMEOUT_ERROR||e.errMsg&&e.errMsg.includes("fail")}isAuthError(e){return e.type===r.ERROR_TYPES.AUTH_ERROR}delay(e){return new Promise((r=>setTimeout(r,e)))}};exports.del=(e,r)=>s.delete(e,r),exports.get=(e,r,t)=>s.get(e,r,t),exports.post=(e,r,t)=>s.post(e,r,t),exports.request=s,exports.upload=(e,r,t,o)=>s.upload(e,r,t,o);
