"use strict";var e=Object.defineProperty,t=(t,s,r)=>(((t,s,r)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[s]=r})(t,"symbol"!=typeof s?s+"":s,r),r);const s=require("../common/vendor.js"),r=require("./constants.js");class o{static setTokens(e){const{accessToken:t,refreshToken:o,expiresIn:n}=e,a=Date.now()+this.parseExpiresIn(n);s.index.setStorageSync(r.STORAGE_KEYS.ACCESS_TOKEN,t),s.index.setStorageSync(r.STORAGE_KEYS.REFRESH_TOKEN,o),s.index.setStorageSync(r.STORAGE_KEYS.TOKEN_EXPIRES_AT,a),console.log("ğŸ”‘ Tokenå·²æ›´æ–°",{expiresAt:new Date(a)})}static getAccessToken(){return s.index.getStorageSync(r.STORAGE_KEYS.ACCESS_TOKEN)||null}static getRefreshToken(){return s.index.getStorageSync(r.STORAGE_KEYS.REFRESH_TOKEN)||null}static shouldRefreshToken(){const e=s.index.getStorageSync(r.STORAGE_KEYS.TOKEN_EXPIRES_AT);if(!e)return!1;return e-Date.now()<=r.API_CONFIG.TOKEN_REFRESH_THRESHOLD}static isTokenExpired(){const e=s.index.getStorageSync(r.STORAGE_KEYS.TOKEN_EXPIRES_AT);return!e||Date.now()>=e}static clearTokens(){s.index.removeStorageSync(r.STORAGE_KEYS.ACCESS_TOKEN),s.index.removeStorageSync(r.STORAGE_KEYS.REFRESH_TOKEN),s.index.removeStorageSync(r.STORAGE_KEYS.TOKEN_EXPIRES_AT),console.log("ğŸ—‘ï¸ Tokenå·²æ¸…é™¤")}static parseExpiresIn(e){const t=e.slice(-1),s=parseInt(e.slice(0,-1));switch(t){case"s":return 1e3*s;case"m":return 60*s*1e3;case"h":return 60*s*60*1e3;case"d":return 24*s*60*60*1e3;default:return 72e5}}}class n{static setUserInfo(e){s.index.setStorageSync(r.STORAGE_KEYS.USER_INFO,e),console.log("ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°",e)}static getUserInfo(){return s.index.getStorageSync(r.STORAGE_KEYS.USER_INFO)||null}static clearUserInfo(){s.index.removeStorageSync(r.STORAGE_KEYS.USER_INFO),console.log("ğŸ—‘ï¸ ç”¨æˆ·ä¿¡æ¯å·²æ¸…é™¤")}static isAdmin(){const e=this.getUserInfo();return e&&1===e.role_id}static isUserActive(){const e=this.getUserInfo();return e&&1===e.status}}class a{static getWechatCode(e=!1){return new Promise(((t,r)=>{const o=Date.now();if(!e&&this._lastCode&&o-this._codeTimestamp<2e3)return console.warn("âš ï¸ è·å–codeè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•"),void r(new Error("è·å–æˆæƒè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•"));console.log("ğŸ” å¼€å§‹è·å–å…¨æ–°çš„å¾®ä¿¡Code..."),s.index.login({provider:"weixin",onlyAuthorize:!0,success:s=>(console.log("ğŸ” è·å–æˆåŠŸ",s),s.code?e||s.code!==this._lastCode?(this._lastCode=s.code,this._codeTimestamp=o,console.log("âœ… è·å–å¾®ä¿¡CodeæˆåŠŸ",{code:s.code.substring(0,8)+"...",timestamp:new Date(o).toLocaleTimeString()}),void t(s.code)):(console.warn("âš ï¸ è·å–åˆ°é‡å¤çš„å¾®ä¿¡codeï¼Œå¼ºåˆ¶é‡æ–°è·å–"),void setTimeout((()=>{this.getWechatCode(!0).then(t).catch(r)}),500)):(console.error("âŒ å¾®ä¿¡è¿”å›çš„codeä¸ºç©º"),void r(new Error("å¾®ä¿¡æˆæƒå¤±è´¥ï¼Œè¯·é‡è¯•")))),fail:e=>{console.error("âŒ è·å–å¾®ä¿¡Codeå¤±è´¥",e),r(new Error(e.errMsg||"è·å–å¾®ä¿¡æˆæƒå¤±è´¥ï¼Œè¯·é‡è¯•"))}})}))}static clearCodeCache(){console.log("ğŸ—‘ï¸ æ¸…é™¤å¾®ä¿¡codeç¼“å­˜"),this._lastCode=null,this._codeTimestamp=0}static getUserProfile(){return new Promise(((e,t)=>{s.index.getUserProfile({desc:"ç”¨äºå®Œå–„ä¸ªäººèµ„æ–™",success:t=>{console.log("ğŸ‘¤ è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ",t.userInfo),e({encryptedData:t.encryptedData,iv:t.iv,signature:t.signature,userInfo:t.userInfo})},fail:e=>{console.error("âŒ ç”¨æˆ·å–æ¶ˆæˆæƒ",e),t(new Error("éœ€è¦æˆæƒæ‰èƒ½ä½¿ç”¨å®Œæ•´åŠŸèƒ½"))}})}))}static isWechatLoginSupported(){return!0}}t(a,"_lastCode",null),t(a,"_codeTimestamp",0);class i{static setLoginState(e){s.index.setStorageSync(r.STORAGE_KEYS.LOGIN_STATE,e)}static getLoginState(){return s.index.getStorageSync(r.STORAGE_KEYS.LOGIN_STATE)||!1}static clearLoginState(){s.index.removeStorageSync(r.STORAGE_KEYS.LOGIN_STATE)}static logout(){o.clearTokens(),n.clearUserInfo(),this.clearLoginState(),console.log("ğŸšª ç”¨æˆ·å·²ç™»å‡º")}}class c{static isProtectedRoute(e){return!this.isPublicRoute(e)}static isPublicRoute(e){return this.PUBLIC_ROUTES.some((t=>e.startsWith(t)))}static saveReturnPath(e){s.index.setStorageSync("return_path",e)}static getAndClearReturnPath(){const e=s.index.getStorageSync("return_path")||"/pages/index/index";return s.index.removeStorageSync("return_path"),e}}t(c,"PUBLIC_ROUTES",["/pages/login/login"]);exports.LoginStateManager=i,exports.PermissionChecker=class{static hasPermission(e){const t=n.getUserInfo();if(!t)return!1;if(1===t.role_id)return!0;switch(e){case"file_upload":return i.getLoginState();case"user_management":return 1===t.role_id;default:return!0}}static checkFeatureAvailable(e){const t=i.getLoginState(),s=n.getUserInfo();switch(e){case"file_upload":return t?{available:!0,message:""}:{available:!1,message:"è¯·å…ˆç™»å½•åå†ä½¿ç”¨æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½"};case"profile_management":return t?{available:!0,message:""}:{available:!1,message:"è¯·å…ˆç™»å½•åå†æŸ¥çœ‹ä¸ªäººèµ„æ–™"};case"admin_functions":return s&&1===s.role_id?{available:!0,message:""}:{available:!1,message:"ä»…ç®¡ç†å‘˜å¯ä½¿ç”¨æ­¤åŠŸèƒ½"};default:return{available:!0,message:""}}}},exports.RouteGuard=c,exports.TokenManager=o,exports.UserManager=n,exports.WechatAuth=a;
