"use strict";const e=require("../common/vendor.js"),t=require("./auth.js");exports.NavigationGuard=class{static checkPageAccess(e){const n=this.extractPagePath(e);if(console.log("ğŸš¦ æ£€æŸ¥é¡µé¢è®¿é—®æƒé™:",n),t.RouteGuard.isPublicRoute(n))return console.log("âœ… å…¬å¼€é¡µé¢ï¼Œå…è®¸è®¿é—®"),!0;if(t.RouteGuard.isProtectedRoute(n)){return t.LoginStateManager.getLoginState()?(console.log("âœ… å·²ç™»å½•ï¼Œå…è®¸è®¿é—®å—ä¿æŠ¤é¡µé¢"),!0):(console.log("âŒ å—ä¿æŠ¤é¡µé¢ï¼Œéœ€è¦ç™»å½•"),this.handleUnauthorizedAccess(n),!1)}return console.log("âœ… å…¬å¼€é¡µé¢ï¼Œå…è®¸è®¿é—®"),!0}static async safeNavigate(t){const{url:n,type:o="navigateTo",extra:r={}}=t;try{if(!this.checkPageAccess(n))return!1;const t=e.index[o];if(!t)throw new Error(`ä¸æ”¯æŒçš„å¯¼èˆªç±»å‹: ${o}`);return await new Promise(((e,o)=>{t({url:n,...r,success:e,fail:o})})),console.log("âœ… é¡µé¢è·³è½¬æˆåŠŸ:",n),!0}catch(i){return console.error("âŒ é¡µé¢è·³è½¬å¤±è´¥:",i),e.index.showToast({title:"é¡µé¢è·³è½¬å¤±è´¥",icon:"error"}),!1}}static handleUnauthorizedAccess(n){t.RouteGuard.saveReturnPath(n),e.index.showModal({title:"éœ€è¦ç™»å½•",content:"è®¿é—®æ­¤é¡µé¢éœ€è¦ç™»å½•ï¼Œæ˜¯å¦ç«‹å³ç™»å½•ï¼Ÿ",confirmText:"ç«‹å³ç™»å½•",cancelText:"ç¨åå†è¯´",success:t=>{t.confirm&&e.index.navigateTo({url:"/pages/login/login"})}})}static extractPagePath(e){const t=e.split("?")[0];return t.startsWith("/")?t:`/${t}`}static setupAutoLoginInterceptor(){console.log("ğŸ›¡ï¸ è®¾ç½®è‡ªåŠ¨ç™»å½•æ‹¦æˆªå™¨");const t={navigateTo:e.index.navigateTo,redirectTo:e.index.redirectTo,reLaunch:e.index.reLaunch,switchTab:e.index.switchTab};Object.keys(t).forEach((n=>{e.index[n]=e=>{if(!e.url||this.checkPageAccess(e.url))return t[n](e)}}))}static checkCurrentPagePermission(){const n=getCurrentPages();if(0===n.length)return;const o=`/${n[n.length-1].route}`;if(t.RouteGuard.isProtectedRoute(o)){t.LoginStateManager.getLoginState()||(console.log("âš ï¸ å½“å‰é¡µé¢éœ€è¦ç™»å½•æƒé™"),setTimeout((()=>{e.index.showToast({title:"å»ºè®®ç™»å½•åä½¿ç”¨å®Œæ•´åŠŸèƒ½",icon:"none",duration:2e3})}),1e3))}}static handleLoginSuccess(){const n=t.RouteGuard.getAndClearReturnPath();console.log("ğŸ‰ ç™»å½•æˆåŠŸï¼Œå‡†å¤‡è·³è½¬:",n),n&&"/pages/index/index"!==n?e.index.redirectTo({url:n,fail:()=>{e.index.reLaunch({url:"/pages/index/index"})}}):e.index.reLaunch({url:"/pages/index/index"})}};
