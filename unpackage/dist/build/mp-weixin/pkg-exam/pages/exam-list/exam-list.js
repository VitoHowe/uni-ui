"use strict";const e=require("../../../common/vendor.js"),t=require("../../../utils/request.js"),o=require("../../utils/subject.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const a={__name:"exam-list",setup(a){const n=e.ref(""),r=e.ref(!1),l=e.ref([]),s=e.ref([]),c=e.ref(o.SubjectStorage.get()),u=e.ref(!1),i=e.ref({answered_count:0,correct_count:0,wrong_count:0,accuracy:0}),d=e.ref(null),p=[{label:"æœ€æ–°åˆ›å»º",value:"created_desc"},{label:"æœ€æ—©åˆ›å»º",value:"created_asc"},{label:"é¢˜ç›®æœ€å¤š",value:"questions_desc"},{label:"é¢˜ç›®æœ€å°‘",value:"questions_asc"}],v=e.ref("created_desc"),_=e.ref(null),m=e.ref(null),h=e.ref(null),f=e.ref(null),g=e=>{c.value=e,o.SubjectStorage.set(e)},b=()=>{i.value={answered_count:0,correct_count:0,wrong_count:0,accuracy:0}},y=async()=>{if(x())try{const e=await t.get("/practice/summary",{subjectId:c.value.id,mode:"mock"},{showLoading:!1});i.value=e.stats||{answered_count:0,correct_count:0,wrong_count:0,accuracy:0}}catch(e){console.error("èŽ·å–ç»ƒä¹ ç»Ÿè®¡å¤±è´¥:",e),b()}else b()},w=()=>{u.value||(s.value.length?e.index.showActionSheet({itemList:s.value.map((e=>e.name)),success:async e=>{const t=s.value[e.tapIndex];t&&(g(t),await y(),await L())}}):e.index.showToast({title:"æš‚æ— å¯é€‰ç§‘ç›®",icon:"none"}))},x=()=>!!c.value||(e.index.showToast({title:"è¯·å…ˆé€‰æ‹©ç§‘ç›®",icon:"none"}),!1),q=e.computed((()=>l.value.length)),$=e.computed((()=>l.value.reduce(((e,t)=>e+t.total_questions),0))),z=e.computed((()=>{const e=(new Date).toDateString();return l.value.filter((t=>new Date(t.created_at).toDateString()===e)).length})),j=e.computed((()=>{let e=[...l.value];if(n.value){const t=n.value.toLowerCase();e=e.filter((e=>e.bank_name.toLowerCase().includes(t)||e.file_name.toLowerCase().includes(t)))}return e.sort(((e,t)=>{switch(v.value){case"created_desc":return new Date(t.created_at)-new Date(e.created_at);case"created_asc":return new Date(e.created_at)-new Date(t.created_at);case"questions_desc":return t.total_questions-e.total_questions;case"questions_asc":return e.total_questions-t.total_questions;default:return 0}})),e})),k=async()=>{(()=>{var e,t;const o=getCurrentPages(),a=o[o.length-1],n=null==(e=null==a?void 0:a.options)?void 0:e.subjectId,r=null==(t=null==a?void 0:a.options)?void 0:t.subjectName;n&&g({id:Number(n),name:r?decodeURIComponent(r):`ç§‘ç›® ${n}`,code:null})})();const a=o.SubjectStorage.get();a&&(c.value=a),await(async()=>{var a;if(!u.value){u.value=!0;try{if(!x())return void(r.value=!1);null==(a=c.value)||a.id;const e=((await t.get("/subjects")).subjects||[]).map(o.normalizeSubject);if(s.value=e,!c.value&&e.length)return void g(e[0]);if(c.value){const t=e.find((e=>e.id===c.value.id));t?g(t):e.length&&g(e[0])}}catch(n){console.error("èŽ·å–ç§‘ç›®å¤±è´¥:",n),e.index.showToast({title:n.message||"èŽ·å–ç§‘ç›®å¤±è´¥",icon:"none"})}finally{u.value=!1}}})(),c.value?(await y(),await L()):l.value=[]};e.onShow((()=>{console.log("ðŸ“± é¢˜åº“åˆ—è¡¨é¡µé¢æ˜¾ç¤ºï¼Œåˆ·æ–°æ•°æ®..."),k()}));const L=async()=>{var o;r.value=!0;try{if(!x())return void(r.value=!1);const e=null==(o=c.value)?void 0:o.id,a=(await t.get(`/subjects/${e}/banks`,{page:1,limit:20})).banks||[];l.value=a.map((e=>{const t=e.study_progress||{};return{id:e.id,bank_id:e.id,bank_name:e.name,file_name:e.file_original_name,total_questions:e.question_count,created_at:e.created_at,description:e.description,creator_name:e.creator_name,file_type:e.file_type,file_size:e.file_size,totalChapters:t.total_chapters||0,studiedChapters:t.studied_chapters||0,progress:t.progress_percentage||0,completed_count:t.completed_questions||0,last_study_time:t.last_study_time||null,chapters:[],chapterProgress:null,current_chapter_id:null,current_question_number:0}})),console.log("âœ… é¢˜åº“åˆ—è¡¨åŠ è½½å®Œæˆï¼Œå·²ä½¿ç”¨study_progressä¼˜åŒ–æŽ¥å£è°ƒç”¨")}catch(a){console.error("èŽ·å–é¢˜åº“åˆ—è¡¨å¤±è´¥:",a),e.index.showToast({title:a.message||"åŠ è½½å¤±è´¥",icon:"none"})}finally{r.value=!1}},T=e=>{if(!e.questions||0===e.questions.length)return[];const t={single:{label:"å•é€‰",count:0,type:"single"},multiple:{label:"å¤šé€‰",count:0,type:"multiple"},judge:{label:"åˆ¤æ–­",count:0,type:"judge"},fill:{label:"å¡«ç©º",count:0,type:"fill"}};return e.questions.forEach((e=>{t[e.type]&&t[e.type].count++})),Object.values(t).filter((e=>e.count>0))},C=e=>{const t=new Date(e),o=new Date-t,a=Math.floor(o/6e4),n=Math.floor(o/36e5),r=Math.floor(o/864e5);return a<1?"åˆšåˆš":a<60?`${a}åˆ†é’Ÿå‰`:n<24?`${n}å°æ—¶å‰`:r<7?`${r}å¤©å‰`:`${t.getMonth()+1}æœˆ${t.getDate()}æ—¥`},P=()=>{},S=()=>{n.value=""},D=()=>{_.value.open()},M=()=>{v.value="created_desc"},I=()=>{_.value.close()},A=e=>e.last_study_time&&0!==e.completed_count?`å·²å­¦ä¹  ${e.studiedChapters}/${e.totalChapters} ç« èŠ‚`:"å°šæœªå¼€å§‹",F=async o=>{if(d.value=o,!o.chapters||0===o.chapters.length)try{e.index.showLoading({title:"åŠ è½½ç« èŠ‚ä¿¡æ¯..."});const a=await t.get(`/question-banks/${o.id}/chapters`);if(o.chapters=a.chapters||[],e.index.hideLoading(),0===o.chapters.length)return void e.index.showToast({title:"è¯¥é¢˜åº“æš‚æ— ç« èŠ‚",icon:"none"})}catch(a){return e.index.hideLoading(),console.error(`èŽ·å–é¢˜åº“${o.id}ç« èŠ‚å¤±è´¥:`,a),void e.index.showToast({title:"åŠ è½½ç« èŠ‚å¤±è´¥",icon:"none"})}h.value.open()},N=async()=>{h.value.close();const o=d.value;if(null===o.chapterProgress)try{e.index.showLoading({title:"åŠ è½½ç« èŠ‚è¿›åº¦..."});const a=await t.get(`/user-progress/${o.id}/chapters`);o.chapterProgress=a||[],e.index.hideLoading()}catch(a){e.index.hideLoading(),console.error(`èŽ·å–é¢˜åº“${o.id}ç« èŠ‚è¿›åº¦å¤±è´¥:`,a),o.chapterProgress=[]}f.value.open()},B=async()=>{var o;h.value.close();const a=d.value;let n=null==(o=a.chapters[0])?void 0:o.id,r=1;try{e.index.showLoading({title:"åŠ è½½è¿›åº¦..."});const o=await t.get(`/user-progress/${a.id}/full`);if(e.index.hideLoading(),o&&o.current_question_number>0){const t=O(a,o.current_chapter_id);return void e.index.showModal({title:"ç»§ç»­ç»ƒä¹ ",content:`ä¸Šæ¬¡å­¦ä¹ åˆ°ã€Œ${t}ã€ç¬¬${o.current_question_number}é¢˜\næ•´ä½“è¿›åº¦ï¼š${Math.round(o.completed_count/a.total_questions*100)}%\n\næ˜¯å¦ç»§ç»­ï¼Ÿ`,confirmText:"ç»§ç»­",cancelText:"ä»Žå¤´å¼€å§‹",success:e=>{e.confirm&&(n=o.current_chapter_id,r=o.current_question_number),E("full",n,r)}})}}catch(l){e.index.hideLoading(),console.error("èŽ·å–æ•´å·ç»ƒä¹ è¿›åº¦å¤±è´¥:",l)}E("full",n,r)},E=(t,o,a=1)=>{var n;const r=d.value,l=null==(n=c.value)?void 0:n.id,s=l?`&subjectId=${l}`:"";e.index.navigateTo({url:`/pkg-exam/pages/exam/exam?bankId=${r.id}&mode=${t}&chapterId=${o}&questionNumber=${a}${s}`})},O=(e,t)=>{var o;const a=null==(o=e.chapters)?void 0:o.find((e=>e.id===t));return a?a.chapter_name:""},R=e=>{var t;if(!d.value)return"æœªå¼€å§‹";const o=null==(t=d.value.chapterProgress)?void 0:t.find((t=>t.chapter_id===e.id));return o&&0!==o.current_question_number?`${o.progress_percentage}%`:"æœªå¼€å§‹"},U=()=>{m.value.close()},G=()=>{m.value.close(),e.index.showToast({title:"åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­",icon:"none"})},H=()=>{if(!d.value)return;const o=d.value;m.value.close(),e.index.showModal({title:"é‡ç½®å­¦ä¹ è¿›åº¦",content:`ç¡®å®šè¦é‡ç½®ã€Œ${o.bank_name}ã€çš„æ‰€æœ‰ç« èŠ‚å­¦ä¹ è¿›åº¦å—ï¼Ÿ\n\nå½“å‰æ•´ä½“è¿›åº¦ï¼š${o.progress}%\nå·²å®Œæˆï¼š${o.completed_count} é¢˜\n\né‡ç½®åŽå°†ä»Žç¬¬ä¸€é¢˜é‡æ–°å¼€å§‹ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,confirmText:"é‡ç½®",confirmColor:"#ff9500",cancelText:"å–æ¶ˆ",success:async a=>{if(a.confirm)try{e.index.showLoading({title:"é‡ç½®ä¸­..."}),await t.del(`/user-progress/${o.id}`),await L(),e.index.hideLoading(),e.index.showToast({title:"é‡ç½®æˆåŠŸ",icon:"success",duration:2e3}),console.log(`ðŸ”„ é¢˜åº“ ${o.bank_name} å­¦ä¹ è¿›åº¦å·²é‡ç½®`)}catch(n){e.index.hideLoading(),console.error("é‡ç½®è¿›åº¦å¤±è´¥:",n),e.index.showToast({title:n.message||"é‡ç½®å¤±è´¥",icon:"none",duration:2e3})}}})},J=()=>{e.index.navigateTo({url:"/pkg-tools/pages/upload/upload"})};return(t,o)=>{var a,l;return e.e({a:e.t((null==(a=c.value)?void 0:a.name)||"è¯·é€‰æ‹©ç§‘ç›®"),b:e.t(s.value.length?"åˆ‡æ¢":"åŠ è½½ä¸­"),c:e.p({type:"arrowdown",size:"16",color:"#999"}),d:e.o(w),e:e.p({type:"search",size:"18",color:"#999"}),f:e.o([e=>n.value=e.detail.value,P]),g:n.value,h:n.value},n.value?{i:e.o(S),j:e.p({type:"clear",size:"16",color:"#999"})}:{},{k:e.p({type:"funnel",size:"18",color:"#333"}),l:e.o(D),m:e.t(i.value.answered_count),n:e.t(i.value.accuracy),o:e.t(i.value.wrong_count),p:e.t(q.value),q:e.t($.value),r:e.t(z.value),s:r.value},r.value?{t:e.p({type:"spinner-cycle",size:"40",color:"#3B82F6"})}:0===j.value.length?{w:e.p({type:"folder-add",size:"80",color:"#ddd"}),x:e.p({type:"plus",size:"16",color:"#fff"}),y:e.o(J)}:{z:e.f(j.value,((t,o,a)=>e.e({a:"2b01e2b8-7-"+a,b:e.t(t.bank_name),c:e.t(t.file_name),d:"2b01e2b8-8-"+a,e:e.o((e=>(e=>{d.value=e,m.value.open()})(t)),t.id),f:"2b01e2b8-9-"+a,g:e.t(t.total_questions),h:"2b01e2b8-10-"+a,i:e.t(C(t.created_at)),j:e.f(T(t),((t,o,a)=>({a:e.t(t.label),b:e.t(t.count),c:o,d:e.n("tag-"+t.type)}))),k:e.t(t.progress||0),l:(t.progress||0)+"%",m:e.t(A(t)),n:t.completed_count>0},t.completed_count>0?{o:e.t(t.completed_count)}:{},{p:"2b01e2b8-11-"+a,q:e.t(t.completed_count>0?"ç»§ç»­å­¦ä¹ ":"å¼€å§‹ç»ƒä¹ "),r:e.o((e=>F(t)),t.id),s:t.id,t:e.o((e=>F(t)),t.id)}))),A:e.p({type:"paperplane",size:"24",color:"#fff"}),B:e.p({type:"more-filled",size:"20",color:"#999"}),C:e.p({type:"compose",size:"16",color:"#666"}),D:e.p({type:"calendar",size:"16",color:"#666"}),E:e.p({type:"forward",size:"16",color:"#fff"})},{v:0===j.value.length,F:e.o(M),G:e.f(p,((t,o,a)=>e.e({a:e.t(t.label),b:v.value===t.value},v.value===t.value?{c:"2b01e2b8-13-"+a+",2b01e2b8-12",d:e.p({type:"checkmarkempty",size:"18",color:"#007AFF"})}:{},{e:t.value,f:v.value===t.value?1:"",g:e.o((e=>{return o=t.value,void(v.value=o);var o}),t.value)}))),H:e.o(I),I:e.sr(_,"2b01e2b8-12",{k:"filterPopup"}),J:e.p({type:"bottom"}),K:e.p({type:"redo",size:"20",color:"#333"}),L:e.o(G),M:d.value&&d.value.completed_count>0},d.value&&d.value.completed_count>0?{N:e.p({type:"refreshempty",size:"20",color:"#ff9500"}),O:e.o(H)}:{},{P:e.o(U),Q:e.sr(m,"2b01e2b8-14",{k:"actionPopup"}),R:e.p({type:"bottom"}),S:e.p({type:"closeempty",size:"20",color:"#999"}),T:e.o((e=>h.value.close())),U:e.p({type:"list",size:"40",color:"#667eea"}),V:e.o(N),W:e.p({type:"paperplane",size:"40",color:"#f5576c"}),X:e.o(B),Y:e.sr(h,"2b01e2b8-17",{k:"modePopup"}),Z:e.p({type:"center"}),aa:e.p({type:"closeempty",size:"20",color:"#999"}),ab:e.o((e=>f.value.close())),ac:e.f(null==(l=d.value)?void 0:l.chapters,((t,o,a)=>({a:e.t(t.chapter_name),b:e.t(t.question_count),c:e.t(R(t)),d:"2b01e2b8-23-"+a+",2b01e2b8-21",e:t.id,f:e.o((o=>(t=>{var o;f.value.close();const a=null==(o=d.value.chapterProgress)?void 0:o.find((e=>e.chapter_id===t.id));let n=1;a&&a.current_question_number>0?e.index.showModal({title:"ç»§ç»­ç»ƒä¹ ",content:`ã€Œ${t.chapter_name}ã€\n\nä¸Šæ¬¡å­¦ä¹ åˆ°ç¬¬${a.current_question_number}é¢˜\nè¿›åº¦ï¼š${a.progress_percentage}%\n\næ˜¯å¦ç»§ç»­ï¼Ÿ`,confirmText:"ç»§ç»­",cancelText:"ä»Žå¤´å¼€å§‹",success:e=>{e.confirm&&(n=a.current_question_number),E("chapter",t.id,n)}}):E("chapter",t.id,n)})(t)),t.id)}))),ad:e.p({type:"forward",size:"16",color:"#999"}),ae:e.sr(f,"2b01e2b8-21",{k:"chapterSelectPopup"}),af:e.p({type:"bottom"})})}}},n=e._export_sfc(a,[["__scopeId","data-v-2b01e2b8"]]);wx.createPage(n);
