"use strict";const e=require("../../../common/vendor.js"),t=require("../../../utils/request.js"),a=require("../../utils/subject.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const o={__name:"special-list",setup(o){const n=e.ref([]),c=e.ref(!1),s=e.ref([]),r=e.ref(a.SubjectStorage.get()),u=e.ref(!1),l=e.ref({}),i=e.ref({answered_count:0,correct_count:0,wrong_count:0,accuracy:0}),d=e=>{r.value=e,a.SubjectStorage.set(e)},v=()=>!!r.value||(e.index.showToast({title:"请先选择科目",icon:"none"}),!1),p=e=>{var t;const a=(null==(t=l.value)?void 0:t[e])||0;return Math.min(Math.max(Number(a),0),100)},g=e=>e.display_name||e.chapter_name||`章节 ${e.id}`,m=()=>{i.value={answered_count:0,correct_count:0,wrong_count:0,accuracy:0}},h=async()=>{if(v())try{const e=await t.get("/practice/summary",{subjectId:r.value.id,mode:"special"},{showLoading:!1});i.value=e.stats||{answered_count:0,correct_count:0,wrong_count:0,accuracy:0}}catch(e){console.error("获取练习统计失败:",e),m()}else m()},w=async()=>{if(v()){c.value=!0;try{const e=await t.get(`/subjects/${r.value.id}/chapters`);n.value=e.chapters||[],await(async()=>{if(v())try{const e=await t.get(`/subjects/${r.value.id}/chapters/progress`,{},{showLoading:!1}),a=Array.isArray(e)?e:e.progress||[],o={};a.forEach((e=>{if(!e)return;const t=void 0!==e.progress_percentage?Number(e.progress_percentage):e.total_questions>0?Math.round(e.completed_count/e.total_questions*100):0;o[e.subject_chapter_id]=t})),l.value=o}catch(e){console.error("获取专项进度失败:",e)}else l.value={}})()}catch(a){console.error("获取章节失败:",a),e.index.showToast({title:a.message||"获取章节失败",icon:"none"})}finally{c.value=!1}}else n.value=[]},_=()=>{u.value||(s.value.length?e.index.showActionSheet({itemList:s.value.map((e=>e.name)),success:async e=>{const t=s.value[e.tapIndex];t&&(d(t),await h(),await w())}}):e.index.showToast({title:"暂无可选科目",icon:"none"}))};return e.onShow((async()=>{(()=>{var e,t;const a=getCurrentPages(),o=a[a.length-1],n=null==(e=null==o?void 0:o.options)?void 0:e.subjectId,c=null==(t=null==o?void 0:o.options)?void 0:t.subjectName;n&&d({id:Number(n),name:c?decodeURIComponent(c):`科目 ${n}`,code:null})})();const o=a.SubjectStorage.get();o&&(r.value=o),await(async()=>{if(!u.value){u.value=!0;try{const e=((await t.get("/subjects")).subjects||[]).map(a.normalizeSubject);if(s.value=e,!r.value&&e.length)return void d(e[0]);if(r.value){const t=e.find((e=>e.id===r.value.id));t?d(t):e.length&&d(e[0])}}catch(o){console.error("获取科目失败:",o),e.index.showToast({title:o.message||"获取科目失败",icon:"none"})}finally{u.value=!1}}})(),await h(),await w()})),(t,a)=>{var o;return e.e({a:e.t((null==(o=r.value)?void 0:o.name)||"请选择科目"),b:e.t(s.value.length?"切换":"加载中"),c:e.p({type:"arrowdown",size:"16",color:"#999"}),d:e.o(_),e:e.t(i.value.answered_count),f:e.t(i.value.accuracy),g:e.t(i.value.wrong_count),h:c.value},c.value?{i:e.p({type:"spinner-cycle",size:"40",color:"#3B82F6"})}:0===n.value.length?{k:e.p({type:"folder-add",size:"80",color:"#ddd"})}:{l:e.f(n.value,((t,a,o)=>({a:e.t(g(t)),b:e.t(t.question_count||0),c:`${p(t.id)}%`,d:e.t(p(t.id)),e:t.id,f:e.o((a=>(t=>{var a,o;const n=(null==(a=r.value)?void 0:a.id)||0,c=(null==(o=r.value)?void 0:o.name)||"",s=g(t);e.index.navigateTo({url:`/pkg-exam/pages/exam/exam?mode=special&subjectId=${n}&subjectName=${encodeURIComponent(c)}&subjectChapterId=${t.id}&chapterName=${encodeURIComponent(s)}`})})(t)),t.id)})))},{j:0===n.value.length})}}},n=e._export_sfc(o,[["__scopeId","data-v-78a5d47b"]]);wx.createPage(n);
