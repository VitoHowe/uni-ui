"use strict";const e=require("../../../common/vendor.js"),t=require("../../../utils/request.js"),a=require("../../../utils/constants.js"),r=require("../../utils/essayParser.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const l={__name:"essay-detail",setup(l){const s=e.ref(0),n=e.ref(null),u=e.ref(""),o=e.ref(""),i=e.ref([]),v=e.ref(""),c=e.ref(!1),d=e.ref(1.3),f=t=>new Promise(((a,r)=>{e.index.request({url:t,method:"GET",responseType:"text",success:e=>{e.statusCode>=200&&e.statusCode<300?a((e=>{if("string"==typeof e)return e;if(null==e)return"";if("object"==typeof e){if("string"==typeof e.content)return e.content;if("string"==typeof e.data)return e.data;try{return JSON.stringify(e)}catch(t){return String(e)}}return String(e)})(e.data)):r(new Error(`论文内容加载失败（${e.statusCode}）`))},fail:e=>{r(new Error(e.errMsg||"论文内容加载失败"))}})})),p=()=>{if(!u.value)return void(o.value="");const e=d.value>1.3;o.value=r.parseEssayMarkdown(u.value,{preFontScale:d.value,tableFontScale:d.value,allowHorizontalScroll:e})},g=async()=>{if(s.value){c.value=!0,v.value="";try{const l=await t.get(a.API_ENDPOINTS.ESSAYS.DETAIL(s.value),{},{showLoading:!1});n.value=l;const o=(e=l.content_url)?/^https?:\/\//i.test(e)?e:`${a.API_CONFIG.BASE_URL.replace(/\/api\/?$/,"")}${e.startsWith("/")?"":"/"}${e}`:"";if(!o)throw new Error("论文内容地址无效");const v=await f(o);u.value=v;const d=a.API_CONFIG.BASE_URL.replace(/\/api\/?$/,"");i.value=r.extractEssayImageUrls(v,d),p()}catch(l){console.error("加载论文失败:",l),v.value=l.message||"加载论文失败",u.value="",o.value="",i.value=[]}finally{c.value=!1}var e}else v.value="缺少 essayId 参数"},h=(t="")=>{if(!i.value.length)return;const a=t&&i.value.includes(t)?t:i.value[0];e.index.previewImage({urls:i.value,current:a})},y=e=>{var t;const r=(null==(t=null==e?void 0:e.detail)?void 0:t.node)||(null==e?void 0:e.detail)||{};if("img"!==String((null==r?void 0:r.name)||"").toLowerCase())return;const l=(null==r?void 0:r.attrs)||{},s=(e=>{const t=String(e||"").trim();return t?/^https?:\/\//i.test(t)?t:/^\/\//.test(t)?`https:${t}`:/^data:/i.test(t)?t:`${a.API_CONFIG.BASE_URL.replace(/\/api\/?$/,"")}${t.startsWith("/")?"":"/"}${t}`:""})(l.src||l["data-src"]||"");s&&h(s)},m=e=>{const t=Number((d.value+e).toFixed(2));d.value=Math.max(.6,Math.min(2.4,t)),p()},_=()=>{d.value=1.3,p()},w=e=>{if(!e)return"-";const t=String(e);return t.length>=16?t.slice(0,16).replace("T"," "):t.replace("T"," ")};return e.onLoad((t=>{s.value=Number(t.essayId||0),t.essayTitle&&e.index.setNavigationBarTitle({title:decodeURIComponent(t.essayTitle)}),g()})),e.onPullDownRefresh((async()=>{await g(),e.index.stopPullDownRefresh()})),(t,a)=>e.e({a:n.value},n.value?{b:e.t(n.value.title),c:e.t(n.value.org_name||"-"),d:e.t(n.value.subject_chapter_name||"-"),e:e.t(w(n.value.updated_at))}:{},{f:c.value},c.value?{g:e.p({type:"spinner-cycle",size:"34",color:"#0f766e"})}:v.value?{i:e.t(v.value),j:e.o(g)}:o.value?e.e({l:i.value.length>0},i.value.length>0?{m:e.t(i.value.length),n:e.o((e=>h()))}:{},{o:e.t(Math.round(100*d.value)),p:d.value>1.3},(d.value,{}),{q:e.o((e=>m(-.01))),r:e.o((e=>m(.01))),s:e.o(_),t:o.value,v:e.o(y)}):{},{h:v.value,k:!o.value})}},s=e._export_sfc(l,[["__scopeId","data-v-d05ea17b"]]);wx.createPage(s);
