"use strict";const e=require("../../../common/vendor.js"),a=require("../../../utils/request.js"),t=require("../../utils/subject.js"),l=require("../../../utils/constants.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const s={__name:"essay-list",setup(s){const n=e.ref([]),u=e.ref(t.SubjectStorage.get()),i=e.ref([]),o=e.ref(null),r=e.ref([]),c=e.ref(!1),v=e.ref(!1),d=e.ref(!1),g=e.computed((()=>o.value&&i.value.find((e=>e.id===o.value))||null)),h=e=>{u.value=e,t.SubjectStorage.set(e)},p=async()=>{if(!d.value){d.value=!0;try{const e=((await a.get(l.API_ENDPOINTS.SUBJECTS.LIST,{},{showLoading:!1})).subjects||[]).map(t.normalizeSubject);if(n.value=e,!u.value&&e.length>0)return void h(e[0]);if(u.value){const a=e.find((e=>e.id===u.value.id));a?h(a):e.length>0?h(e[0]):h(null)}}catch(s){console.error("获取科目失败:",s),e.index.showToast({title:s.message||"获取科目失败",icon:"none"})}finally{d.value=!1}}},y=async()=>{if(u.value&&o.value){v.value=!0;try{const e=u.value.id,t=o.value,s=(await a.get(l.API_ENDPOINTS.ESSAYS.SUBJECT_LIST(e),{orgId:t},{showLoading:!1})).essays||[],n=new Map;s.forEach((e=>{const a=Number(e.subject_chapter_id)||0,t=e.subject_chapter_name||"未分类章节";n.has(a)||n.set(a,{chapter_id:a,chapter_name:t,essays:[]}),n.get(a).essays.push(e)})),r.value=Array.from(n.values())}catch(t){console.error("加载机构论文失败:",t),e.index.showToast({title:t.message||"加载论文失败",icon:"none"}),r.value=[]}finally{v.value=!1}}else r.value=[]},f=async()=>{if(!(await(async()=>(u.value||await p(),!!u.value))()))return void(r.value=[]);const e=u.value.id;c.value=!0;try{await(async e=>{const t=await a.get(l.API_ENDPOINTS.ESSAYS.SUBJECT_ORGS(e),{},{showLoading:!1});if(i.value=t.orgs||[],0===i.value.length)return o.value=null,void(r.value=[]);const s=i.value.find((e=>e.id===o.value));o.value=s?s.id:i.value[0].id})(e)}finally{c.value=!1}await y()},S=()=>{n.value.length?e.index.showActionSheet({itemList:n.value.map((e=>e.name)),success:async e=>{const a=n.value[e.tapIndex];a&&(h(a),o.value=null,await f())}}):e.index.showToast({title:"暂无可选科目",icon:"none"})},m=e=>{if(!e)return"-";const a=String(e);return a.length>=16?a.slice(0,16).replace("T"," "):a.replace("T"," ")};return e.onShow((async()=>{const e=t.SubjectStorage.get();e&&(u.value=e),await p(),await f()})),(a,t)=>{var l;return e.e({a:e.t((null==(l=u.value)?void 0:l.name)||"请选择科目"),b:e.t(n.value.length?"切换":"加载中"),c:e.p({type:"arrowdown",size:"16",color:"#0f766e"}),d:e.o(S),e:g.value},g.value?{f:e.t(g.value.name)}:{},{g:c.value},c.value?{h:e.p({type:"spinner-cycle",size:"16",color:"#0f766e"})}:0===i.value.length?{}:{j:e.f(i.value,((a,t,l)=>({a:e.t(a.name),b:e.t(a.essay_count||0),c:o.value===a.id?1:"",d:a.id,e:e.o((e=>(async e=>{o.value!==e&&(o.value=e,await y())})(a.id)),a.id)})))},{i:0===i.value.length,k:g.value},g.value?{l:e.t(g.value.name)}:{},{m:v.value},v.value?{n:e.p({type:"spinner-cycle",size:"30",color:"#0f766e"})}:0===r.value.length?{}:{p:e.f(r.value,((a,t,l)=>({a:e.t(a.chapter_name),b:e.t(a.essays.length),c:e.f(a.essays,((a,t,s)=>({a:e.t(a.title),b:e.t(m(a.updated_at)),c:"76b59c61-3-"+l+"-"+s,d:a.id,e:e.o((t=>(a=>{e.index.navigateTo({url:`/pkg-exam/pages/essay-detail/essay-detail?essayId=${a.id}&essayTitle=${encodeURIComponent(a.title)}`})})(a)),a.id)}))),d:a.chapter_id}))),q:e.p({type:"arrowright",size:"15",color:"#94a3b8"})},{o:0===r.value.length})}}},n=e._export_sfc(s,[["__scopeId","data-v-76b59c61"]]);wx.createPage(n);
