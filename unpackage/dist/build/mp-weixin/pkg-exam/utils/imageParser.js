"use strict";const e=require("../../common/vendor.js"),t=new e.MarkdownIt({html:!0,linkify:!0,breaks:!0}),r=(e,t,r)=>{const n=new RegExp(`<${t}([^>]*)>`,"gi");return e.replace(n,((e,n)=>{const o=n||"";return/style\s*=/.test(o)?`<${t}${o.replace(/style\\s*=\\s*(["'])(.*?)\\1/i,((e,t,n)=>`style=${t}${n.trim().endsWith(";")?`${n}${r}`:`${n};${r}`}${t}`))}>`:`<${t}${o} style="${r}">`}))};function n(e,t,r="http://localhost:3001"){if(!e)return[];const n=[],o=/\$\{images\/([^}]+)\}/g;let s;for(;null!==(s=o.exec(e));){const e=s[1];n.push(`${r}/api/question-banks/${t}/images/${e}`)}return n}exports.extractAllQuestionImages=function(e,t,r="http://localhost:3001"){if(!e)return[];const o=[];return e.content&&o.push(...n(e.content,t,r)),e.explanation&&o.push(...n(e.explanation,t,r)),o},exports.parseQuestionImages=function(n,o,s="http://localhost:3001"){if(!n)return"";const i=((e,t,r)=>e.replace(/\$\{images\/([^}]+)\}/g,((e,n)=>`![image](${r}/api/question-banks/${t}/images/${n})`)))(n,o,s),{text:a,tokens:l}=(e=>{const t=[];let r=e.replace(/\\\$/g,"__WX_ESCAPED_DOLLAR__");return r=r.replace(/\$\$([\s\S]+?)\$\$/g,((e,r)=>{const n=`@@MATH_BLOCK_${t.length}@@`;return t.push({token:n,formula:r,displayMode:!0}),n})),r=r.replace(/\$([^\n$]+?)\$/g,((e,r)=>{const n=`@@MATH_INLINE_${t.length}@@`;return t.push({token:n,formula:r,displayMode:!1}),n})),{text:r,tokens:t}})(i),p=(e=>e?e.replace(/<table[\s\S]*?<\/table>/gi,(e=>{let t=r(e,"table","width:100%;border-collapse:collapse;table-layout:fixed;");return t=r(t,"th","border:1px solid #e5e7eb;padding:6px 8px;font-weight:600;text-align:center;font-size:14px;line-height:1.5;word-break:break-word;"),t=r(t,"td","border:1px solid #e5e7eb;padding:6px 8px;text-align:center;font-size:14px;line-height:1.5;word-break:break-word;"),`<div style="max-width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;">${t}</div>`})):"")((e=>e?r(e,"img","max-width:100%;width:auto;height:auto;display:block;margin:12rpx auto;"):"")((e=>{if(!e)return"";let t=e;return t=t.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi,""),t=t.replace(/<style[\s\S]*?>[\s\S]*?<\/style>/gi,""),t=t.replace(/<(iframe|object|embed)[\s\S]*?>[\s\S]*?<\/\1>/gi,""),t=t.replace(/\son\w+=(["']).*?\1/gi,""),t=t.replace(/\son\w+=\S+/gi,""),t=t.replace(/(href|src)=["']\s*javascript:[^"']*["']/gi,'$1="#"'),t})(t.render(a))));return((t,r)=>{let n=t;return r.forEach((({token:t,formula:r,displayMode:o})=>{let s="";try{s=e.katex.renderToString(r.trim(),{throwOnError:!1,displayMode:o,strict:"ignore"})}catch(i){s=r}n=n.split(t).join(s)})),n.replace(new RegExp("__WX_ESCAPED_DOLLAR__","g"),"$")})(p,l)};
