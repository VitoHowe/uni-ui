"use strict";const e=require("../../common/vendor.js"),r=new e.MarkdownIt({html:!0,linkify:!0,breaks:!0,typographer:!0}),t=(e,r,t)=>{const o=new RegExp(`<${r}([^>]*)>`,"gi");return e.replace(o,((e,o)=>{const i=o||"";return/style\s*=/.test(i)?`<${r}${i.replace(/style\s*=\s*(["'])(.*?)\1/i,((e,r,o)=>`style=${r}${o.trim().endsWith(";")?`${o}${t}`:`${o};${t}`}${r}`))}>`:`<${r}${i} style="${t}">`}))},o=(e="")=>{const r=((e="")=>String(e||"").replace(/&nbsp;/gi," ").replace(/&lt;/gi,"<").replace(/&gt;/gi,">").replace(/&amp;/gi,"&").replace(/&#39;/gi,"'").replace(/&quot;/gi,'"'))(e.replace(/<[^>]*>/g,"")).split("\n").reduce(((e,r)=>Math.max(e,((e="")=>{let r=0;for(const t of String(e||""))r+="\t"!==t&&(t.codePointAt(0)||0)<=127?1:2;return r})(r))),0);if(!r)return 13;const t=248/(.62*r);return Number(Math.max(5,Math.min(13,t)).toFixed(2))},i=(e,r="")=>{const t=String(e||"").trim();return t?/^https?:\/\//i.test(t)?t:/^\/\//.test(t)?`https:${t}`:/^data:/i.test(t)?t:r?`${r}${t.startsWith("/")?"":"/"}${t}`:t:""},n=(e="")=>{const r=String(e||"").trim();if(!r)return"";return(r.split(/\s+/)[0]||"").replace(/^<|>$/g,"")};exports.extractEssayImageUrls=(e,r="")=>{if(!e||"string"!=typeof e)return[];const t=[],o=/!\[[^\]]*]\(([^)]+)\)/g,a=/<img[^>]+src=(["'])(.*?)\1/gi;let l=null;for(;null!==(l=o.exec(e));){const e=n(l[1]),o=i(e,r);o&&t.push(o)}for(;null!==(l=a.exec(e));){const e=i(l[2],r);e&&t.push(e)}return Array.from(new Set(t))},exports.parseEssayMarkdown=(i,n={})=>{if(!i||"string"!=typeof i)return"";const{text:a,tokens:l}=(e=>{const r=[];let t=e.replace(/\\\$/g,"__WX_ESSAY_ESCAPED_DOLLAR__");return t=t.replace(/\$\$([\s\S]+?)\$\$/g,((e,t)=>{const o=`@@ESSAY_MATH_BLOCK_${r.length}@@`;return r.push({token:o,formula:t,displayMode:!0}),o})),t=t.replace(/\$([^\n$]+?)\$/g,((e,t)=>{const o=`@@ESSAY_MATH_INLINE_${r.length}@@`;return r.push({token:o,formula:t,displayMode:!1}),o})),{text:t,tokens:r}})(i),s=r.render(a);var p;const c=((e,r={})=>{if(!e)return"";const i=Number(r.preFontScale||1),n=Boolean(r.allowHorizontalScroll);let a=t(e,"code","font-size:13px;padding:2px 6px;background:#f1f5f9;border-radius:6px;color:#0f172a;font-family:Menlo,Consolas,monospace;");return a=a.replace(/<pre[\s\S]*?<\/pre>/gi,(e=>{const r=n?13:o(e),a=Number(Math.max(5,Math.min(18,r*i)).toFixed(2));let l=t(e,"pre",`margin:0;background:transparent;color:#e2e8f0;white-space:pre;word-break:normal;overflow-wrap:normal;font-size:${a}px;line-height:1.45;display:block;`);return l=l.replace(/<code([^>]*)>/gi,'<code$1 style="font-size:inherit;padding:0;background:transparent;color:inherit;font-family:Menlo,Consolas,monospace;white-space:inherit;">'),`<div style="margin:14px 0;border-radius:10px;${n?"overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;":"overflow:hidden;"}background:#0f172a;padding:12px 14px;max-width:100%;">${l}</div>`})),a})(((e,r={})=>{if(!e)return"";const o=Number(r.tableFontScale||1),i=Boolean(r.allowHorizontalScroll),n=Number(Math.max(8,Math.min(18,12.5*o)).toFixed(2));return e.replace(/<table[\s\S]*?<\/table>/gi,(e=>{let r=t(e,"table",`width:100%;max-width:100%;border-collapse:collapse;table-layout:auto;background:#ffffff;font-size:${n}px;`);return r=t(r,"th","border:1px solid #e2e8f0;padding:8px 10px;font-weight:600;text-align:left;color:#0f172a;background:#f8fafc;white-space:nowrap;"),r=t(r,"td","border:1px solid #e2e8f0;padding:8px 10px;line-height:1.6;color:#1f2937;white-space:nowrap;"),`<div style="max-width:100%;${i?"overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;":"overflow:hidden;"}margin:12px 0;border-radius:10px;border:1px solid #e2e8f0;">${r}</div>`}))})((e=>e?t(e,"img","max-width:100%;width:auto;height:auto;display:block;margin:14px auto;border-radius:8px;"):"")((e=>{if(!e)return"";let r=e;return r=t(r,"h1","font-size:26px;line-height:1.4;margin:18px 0 12px;color:#0f172a;font-weight:700;"),r=t(r,"h2","font-size:22px;line-height:1.4;margin:16px 0 10px;color:#0f172a;font-weight:700;"),r=t(r,"h3","font-size:19px;line-height:1.45;margin:14px 0 8px;color:#0f172a;font-weight:700;"),r=t(r,"p","font-size:16px;line-height:1.8;color:#1f2937;margin:10px 0;word-break:break-word;"),r=t(r,"li","font-size:15px;line-height:1.75;color:#1f2937;word-break:break-word;"),r=t(r,"blockquote","margin:14px 0;padding:12px 14px;border-left:4px solid #14b8a6;background:#f0fdfa;color:#0f766e;border-radius:8px;"),r})((p=(e=>{if(!e)return"";let r=e;return r=r.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi,""),r=r.replace(/<style[\s\S]*?>[\s\S]*?<\/style>/gi,""),r=r.replace(/<(iframe|object|embed)[\s\S]*?>[\s\S]*?<\/\1>/gi,""),r=r.replace(/\son\w+=(['"]).*?\1/gi,""),r=r.replace(/\son\w+=\S+/gi,""),r=r.replace(/(href|src)=["']\s*javascript:[^"']*["']/gi,'$1="#"'),r})(s))?p.replace(/<img\b([^>]*)>/gi,((e,r="")=>`<img${r.replace(/\s(?:width|height)\s*=\s*(["']).*?\1/gi,"").replace(/\s(?:width|height)\s*=\s*[^>\s]+/gi,"")}>`)):"")),n),n);return((r,t)=>{let o=r;return t.forEach((({token:r,formula:t,displayMode:i})=>{let n="";try{n=e.katex.renderToString(t.trim(),{throwOnError:!1,displayMode:i,strict:"ignore"})}catch(a){n=t}o=o.split(r).join(n)})),o.replace(new RegExp("__WX_ESSAY_ESCAPED_DOLLAR__","g"),"$")})(c,l)};
