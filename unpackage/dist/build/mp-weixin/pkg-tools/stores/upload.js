"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/request.js"),s=require("../../utils/constants.js"),i=e.defineStore("upload",{state:()=>({currentFileType:0,filesList:[],uploadStatus:{uploading:!1,progress:{show:!1,current:0,total:0,percent:0}},uploadHistory:[{id:1,fileName:"é¡¹ç›®ç®¡ç†åŸºç¡€çŸ¥è¯†.docx",fileType:"çŸ¥è¯†ç‚¹",uploadTime:"2024-01-15 14:30",status:"æˆåŠŸ",fileSize:"2.5MB",recordCount:156},{id:2,fileName:"æ¨¡æ‹Ÿè€ƒè¯•é¢˜åº“.xlsx",fileType:"é¢˜åº“",uploadTime:"2024-01-14 16:45",status:"å¤±è´¥",fileSize:"1.8MB",errorMessage:"æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®"}],config:{fileTypeOptions:["çŸ¥è¯†ç‚¹","é¢˜åº“"],allowedExtensions:{0:["doc","docx","pdf","txt","md"],1:["xlsx","xls","csv","json"]},maxFileSize:10,maxFileCount:5,typeDescriptions:{0:"ä¸Šä¼ çŸ¥è¯†ç‚¹æ–‡æ¡£ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è§£æå¹¶åˆ†ç±»å­˜å‚¨å­¦ä¹ å†…å®¹",1:"ä¸Šä¼ é¢˜åº“æ–‡ä»¶ï¼Œç³»ç»Ÿå°†è§£æé¢˜ç›®ã€é€‰é¡¹å’Œç­”æ¡ˆä¿¡æ¯"}}}),getters:{currentFileTypeText:e=>e.config.fileTypeOptions[e.currentFileType],currentAllowedExtensions:e=>e.config.allowedExtensions[e.currentFileType],currentTypeDescription:e=>e.config.typeDescriptions[e.currentFileType],uploadProgressPercent:e=>{const{current:t,total:s}=e.uploadStatus.progress;return s>0?Math.round(t/s*100):0},successUploadCount:e=>e.uploadHistory.filter((e=>"æˆåŠŸ"===e.status)).length,failedUploadCount:e=>e.uploadHistory.filter((e=>"å¤±è´¥"===e.status)).length},actions:{setFileType(e){this.currentFileType=e,this.clearFiles()},addFiles(t){if(this.filesList.length+t.length>this.config.maxFileCount){const t=`æœ€å¤šåªèƒ½é€‰æ‹©${this.config.maxFileCount}ä¸ªæ–‡ä»¶`;return e.index.showToast({title:t,icon:"none"}),!1}const s=[];for(const e of t)this.validateFile(e)&&s.push({...e,id:Date.now()+Math.random(),uploadStatus:"pending"});return this.filesList.push(...s),s.length>0},validateFile(t){const s=this.getFileExtension(t.name);if(!this.currentAllowedExtensions.includes(s))return e.index.showToast({title:`ä¸æ”¯æŒ${s}æ ¼å¼æ–‡ä»¶`,icon:"none"}),!1;return!(t.size/1048576>this.config.maxFileSize)||(e.index.showToast({title:`æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡${this.config.maxFileSize}MB`,icon:"none"}),!1)},getFileExtension:e=>e.split(".").pop().toLowerCase(),clearFiles(){this.filesList=[]},removeFile(e){const t=this.filesList.findIndex((t=>t.id===e));t>-1&&this.filesList.splice(t,1)},async startUpload(){if(0===this.filesList.length)return e.index.showToast({title:"è¯·å…ˆé€‰æ‹©æ–‡ä»¶",icon:"none"}),!1;if(this.uploadStatus.uploading)return e.index.showToast({title:"æ­£åœ¨ä¸Šä¼ ä¸­...",icon:"none"}),!1;this.uploadStatus.uploading=!0,this.uploadStatus.progress={show:!0,current:0,total:this.filesList.length,percent:0};try{await this.processUpload(),e.index.showToast({title:"ä¸Šä¼ å®Œæˆ",icon:"success"})}catch(t){console.error("ä¸Šä¼ è¿‡ç¨‹å‡ºé”™:",t),e.index.showToast({title:"ä¸Šä¼ è¿‡ç¨‹å‡ºé”™",icon:"error"})}finally{this.uploadStatus.uploading=!1,this.uploadStatus.progress.show=!1}},async processUpload(){for(let t=0;t<this.filesList.length;t++){const s=this.filesList[t];this.uploadStatus.progress.current=t+1,this.uploadStatus.progress.percent=Math.round((t+1)/this.filesList.length*100);try{const e=await this.uploadSingleFile(s);this.addToHistory({fileName:s.name,fileType:this.currentFileTypeText,uploadTime:(new Date).toLocaleString("zh-CN"),status:"æˆåŠŸ",fileSize:this.formatFileSize(s.size),recordCount:e.recordCount||0})}catch(e){this.addToHistory({fileName:s.name,fileType:this.currentFileTypeText,uploadTime:(new Date).toLocaleString("zh-CN"),status:"å¤±è´¥",fileSize:this.formatFileSize(s.size),errorMessage:e.message||"ä¸Šä¼ å¤±è´¥"})}await new Promise((e=>setTimeout(e,1e3)))}this.clearFiles()},async uploadSingleFile(e){try{console.log("ğŸ“¤ å¼€å§‹ä¸Šä¼ æ–‡ä»¶:",e.name),console.log("ğŸ”— ä¸Šä¼ APIç«¯ç‚¹:",s.API_ENDPOINTS.FILES.UPLOAD);const i={name:e.name,description:`${this.currentFileTypeText}æ–‡ä»¶`,type:this.currentFileType};console.log("ğŸ“‹ è¡¨å•æ•°æ®:",i);const o=await t.upload(s.API_ENDPOINTS.FILES.UPLOAD,e.path||e.url,i);return console.log("âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ:",o),{success:!0,recordCount:o.parsed_questions||0,fileId:o.id}}catch(i){throw console.error("âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥:",i),new Error(i.message||"æ–‡ä»¶ä¸Šä¼ å¤±è´¥")}},addToHistory(e){const t={...e,id:Date.now()+Math.random()};this.uploadHistory.unshift(t),this.uploadHistory.length>50&&this.uploadHistory.pop()},clearHistory(){this.uploadHistory=[]},deleteHistoryRecord(e){const t=this.uploadHistory.findIndex((t=>t.id===e));t>-1&&this.uploadHistory.splice(t,1)},formatFileSize(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB"][t]},getStatusIcon:e=>({"æˆåŠŸ":"checkmarkempty","å¤±è´¥":"closeempty","å¤„ç†ä¸­":"spinner-cycle"}[e]||"help"),getStatusColor:e=>({"æˆåŠŸ":"#28a745","å¤±è´¥":"#dc3545","å¤„ç†ä¸­":"#007AFF"}[e]||"#666")}});exports.useUploadStore=i;
