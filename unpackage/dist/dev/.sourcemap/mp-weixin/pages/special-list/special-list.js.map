{"version":3,"file":"special-list.js","sources":["pages/special-list/special-list.vue","../../../HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvc3BlY2lhbC1saXN0L3NwZWNpYWwtbGlzdC52dWU"],"sourcesContent":["<template>\n  <view class=\"special-list\">\n    <view class=\"subject-bar\" @click=\"openSubjectPicker\">\n      <view class=\"subject-info\">\n        <text class=\"subject-label\">当前科目</text>\n        <text class=\"subject-name\">{{ selectedSubject?.name || '请选择科目' }}</text>\n      </view>\n      <view class=\"subject-action\">\n        <text class=\"subject-action-text\">{{ subjects.length ? '切换' : '加载中' }}</text>\n        <uni-icons type=\"arrowdown\" size=\"16\" color=\"#999\" />\n      </view>\n    </view>\n\n    <view class=\"chapter-list\">\n      <view v-if=\"loading\" class=\"loading-state\">\n        <uni-icons type=\"spinner-cycle\" size=\"40\" color=\"#28a745\" class=\"loading-icon\" />\n        <text class=\"loading-text\">正在加载章节...</text>\n      </view>\n\n      <view v-else-if=\"chapters.length === 0\" class=\"empty-state\">\n        <uni-icons type=\"folder-add\" size=\"80\" color=\"#ddd\" />\n        <text class=\"empty-title\">暂无章节</text>\n        <text class=\"empty-desc\">当前科目还没有章节数据</text>\n      </view>\n\n      <view v-else class=\"chapter-cards\">\n        <view class=\"chapter-card\" v-for=\"chapter in chapters\" :key=\"chapter.id\" @click=\"startChapter(chapter)\">\n          <view class=\"card-header\">\n            <text class=\"chapter-name\">{{ getChapterName(chapter) }}</text>\n            <text class=\"chapter-count\">{{ chapter.question_count || 0 }} 题</text>\n          </view>\n          <view class=\"progress-row\">\n            <view class=\"progress-bar\">\n              <view class=\"progress-fill\" :style=\"{ width: `${getChapterProgress(chapter.id)}%` }\"></view>\n            </view>\n            <text class=\"progress-text\">{{ getChapterProgress(chapter.id) }}%</text>\n          </view>\n        </view>\n      </view>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { ref } from 'vue'\nimport { onShow } from '@dcloudio/uni-app'\nimport { get } from '@/utils/request.js'\nimport { SubjectStorage, normalizeSubject } from '@/utils/subject.js'\n\nconst chapters = ref([])\nconst loading = ref(false)\nconst subjects = ref([])\nconst selectedSubject = ref(SubjectStorage.get())\nconst loadingSubjects = ref(false)\nconst progressMap = ref({})\n\nconst syncSelectedSubject = (subject) => {\n  selectedSubject.value = subject\n  SubjectStorage.set(subject)\n}\n\nconst applySubjectFromRoute = () => {\n  const pages = getCurrentPages()\n  const currentPage = pages[pages.length - 1]\n  const subjectId = currentPage?.options?.subjectId\n  const subjectName = currentPage?.options?.subjectName\n  if (subjectId) {\n    syncSelectedSubject({\n      id: Number(subjectId),\n      name: subjectName ? decodeURIComponent(subjectName) : `科目 ${subjectId}`,\n      code: null\n    })\n  }\n}\n\nconst ensureSubjectSelected = () => {\n  if (selectedSubject.value) return true\n  uni.showToast({\n    title: '请先选择科目',\n    icon: 'none'\n  })\n  return false\n}\n\nconst fetchProgress = async () => {\n  if (!ensureSubjectSelected()) {\n    progressMap.value = {}\n    return\n  }\n  try {\n    const response = await get(`/subjects/${selectedSubject.value.id}/chapters/progress`, {}, { showLoading: false })\n    const list = Array.isArray(response) ? response : (response.progress || [])\n    const nextMap = {}\n    list.forEach(item => {\n      if (!item) return\n      const percent = item.progress_percentage !== undefined\n        ? Number(item.progress_percentage)\n        : item.total_questions > 0\n          ? Math.round((item.completed_count / item.total_questions) * 100)\n          : 0\n      nextMap[item.subject_chapter_id] = percent\n    })\n    progressMap.value = nextMap\n  } catch (error) {\n    console.error('获取专项进度失败:', error)\n  }\n}\n\nconst getChapterProgress = (chapterId) => {\n  const value = progressMap.value?.[chapterId] || 0\n  return Math.min(Math.max(Number(value), 0), 100)\n}\n\nconst getChapterName = (chapter) => {\n  return chapter.display_name || chapter.chapter_name || `章节 ${chapter.id}`\n}\n\nconst fetchSubjects = async () => {\n  if (loadingSubjects.value) return\n  loadingSubjects.value = true\n  try {\n    const data = await get('/subjects')\n    const list = (data.subjects || []).map(normalizeSubject)\n    subjects.value = list\n\n    if (!selectedSubject.value && list.length) {\n      syncSelectedSubject(list[0])\n      return\n    }\n\n    if (selectedSubject.value) {\n      const matched = list.find(item => item.id === selectedSubject.value.id)\n      if (matched) {\n        syncSelectedSubject(matched)\n      } else if (list.length) {\n        syncSelectedSubject(list[0])\n      }\n    }\n  } catch (error) {\n    console.error('获取科目失败:', error)\n    uni.showToast({\n      title: error.message || '获取科目失败',\n      icon: 'none'\n    })\n  } finally {\n    loadingSubjects.value = false\n  }\n}\n\nconst fetchChapters = async () => {\n  if (!ensureSubjectSelected()) {\n    chapters.value = []\n    return\n  }\n  loading.value = true\n  try {\n    const response = await get(`/subjects/${selectedSubject.value.id}/chapters`)\n    chapters.value = response.chapters || []\n    await fetchProgress()\n  } catch (error) {\n    console.error('获取章节失败:', error)\n    uni.showToast({\n      title: error.message || '获取章节失败',\n      icon: 'none'\n    })\n  } finally {\n    loading.value = false\n  }\n}\n\nconst openSubjectPicker = () => {\n  if (loadingSubjects.value) return\n  if (!subjects.value.length) {\n    uni.showToast({\n      title: '暂无可选科目',\n      icon: 'none'\n    })\n    return\n  }\n  uni.showActionSheet({\n    itemList: subjects.value.map(item => item.name),\n    success: async (res) => {\n      const subject = subjects.value[res.tapIndex]\n      if (subject) {\n        syncSelectedSubject(subject)\n        await fetchChapters()\n      }\n    }\n  })\n}\n\nconst startChapter = (chapter) => {\n  const subjectId = selectedSubject.value?.id || 0\n  const subjectName = selectedSubject.value?.name || ''\n  const chapterName = getChapterName(chapter)\n  uni.navigateTo({\n    url: `/pages/exam/exam?mode=special&subjectId=${subjectId}&subjectName=${encodeURIComponent(subjectName)}&subjectChapterId=${chapter.id}&chapterName=${encodeURIComponent(chapterName)}`\n  })\n}\n\nonShow(async () => {\n  applySubjectFromRoute()\n  const stored = SubjectStorage.get()\n  if (stored) {\n    selectedSubject.value = stored\n  }\n  await fetchSubjects()\n  await fetchChapters()\n})\n</script>\n\n<style lang=\"scss\" scoped>\n.special-list {\n  padding: 20rpx;\n  background: #f8f9fa;\n  min-height: 100vh;\n}\n\n.subject-bar {\n  background: #fff;\n  border-radius: 16rpx;\n  padding: 24rpx;\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.08);\n  margin-bottom: 20rpx;\n}\n\n.subject-info {\n  display: flex;\n  flex-direction: column;\n  gap: 6rpx;\n}\n\n.subject-label {\n  font-size: 24rpx;\n  color: #999;\n}\n\n.subject-name {\n  font-size: 30rpx;\n  font-weight: 600;\n  color: #333;\n}\n\n.subject-action {\n  display: flex;\n  align-items: center;\n  gap: 10rpx;\n}\n\n.subject-action-text {\n  font-size: 24rpx;\n  color: #666;\n}\n\n.loading-state,\n.empty-state {\n  padding: 80rpx 20rpx;\n  text-align: center;\n  color: #999;\n}\n\n.empty-title {\n  display: block;\n  font-size: 30rpx;\n  color: #666;\n  margin-top: 20rpx;\n}\n\n.empty-desc {\n  display: block;\n  font-size: 24rpx;\n  margin-top: 10rpx;\n}\n\n.chapter-card {\n  background: #fff;\n  border-radius: 16rpx;\n  padding: 24rpx;\n  margin-bottom: 20rpx;\n  box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.08);\n}\n\n.card-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n}\n\n.chapter-name {\n  font-size: 30rpx;\n  font-weight: 600;\n  color: #333;\n}\n\n.chapter-count {\n  font-size: 24rpx;\n  color: #28a745;\n}\n\n.progress-row {\n  display: flex;\n  align-items: center;\n  gap: 16rpx;\n  margin-top: 16rpx;\n}\n\n.progress-bar {\n  flex: 1;\n  height: 12rpx;\n  background: #eef1f4;\n  border-radius: 999rpx;\n  overflow: hidden;\n}\n\n.progress-fill {\n  height: 100%;\n  background: linear-gradient(90deg, #28a745, #6bd46f);\n}\n\n.progress-text {\n  font-size: 24rpx;\n  color: #333;\n  min-width: 70rpx;\n  text-align: right;\n}\n</style>\n","import MiniProgramPage from 'E:/personal/wx/uni-ui/pages/special-list/special-list.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","SubjectStorage","uni","get","normalizeSubject","onShow"],"mappings":";;;;;;;;;;;;;;;AAiDA,UAAM,WAAWA,cAAG,IAAC,EAAE;AACvB,UAAM,UAAUA,cAAG,IAAC,KAAK;AACzB,UAAM,WAAWA,cAAG,IAAC,EAAE;AACvB,UAAM,kBAAkBA,cAAG,IAACC,6BAAe,KAAK;AAChD,UAAM,kBAAkBD,cAAG,IAAC,KAAK;AACjC,UAAM,cAAcA,cAAG,IAAC,EAAE;AAE1B,UAAM,sBAAsB,CAAC,YAAY;AACvC,sBAAgB,QAAQ;AACxBC,oBAAc,eAAC,IAAI,OAAO;AAAA,IAC5B;AAEA,UAAM,wBAAwB,MAAM;;AAClC,YAAM,QAAQ,gBAAiB;AAC/B,YAAM,cAAc,MAAM,MAAM,SAAS,CAAC;AAC1C,YAAM,aAAY,gDAAa,YAAb,mBAAsB;AACxC,YAAM,eAAc,gDAAa,YAAb,mBAAsB;AAC1C,UAAI,WAAW;AACb,4BAAoB;AAAA,UAClB,IAAI,OAAO,SAAS;AAAA,UACpB,MAAM,cAAc,mBAAmB,WAAW,IAAI,MAAM,SAAS;AAAA,UACrE,MAAM;AAAA,QACZ,CAAK;AAAA,MACF;AAAA,IACH;AAEA,UAAM,wBAAwB,MAAM;AAClC,UAAI,gBAAgB;AAAO,eAAO;AAClCC,oBAAAA,MAAI,UAAU;AAAA,QACZ,OAAO;AAAA,QACP,MAAM;AAAA,MACV,CAAG;AACD,aAAO;AAAA,IACT;AAEA,UAAM,gBAAgB,YAAY;AAChC,UAAI,CAAC,sBAAqB,GAAI;AAC5B,oBAAY,QAAQ,CAAE;AACtB;AAAA,MACD;AACD,UAAI;AACF,cAAM,WAAW,MAAMC,cAAAA,IAAI,aAAa,gBAAgB,MAAM,EAAE,sBAAsB,CAAA,GAAI,EAAE,aAAa,MAAK,CAAE;AAChH,cAAM,OAAO,MAAM,QAAQ,QAAQ,IAAI,WAAY,SAAS,YAAY;AACxE,cAAM,UAAU,CAAE;AAClB,aAAK,QAAQ,UAAQ;AACnB,cAAI,CAAC;AAAM;AACX,gBAAM,UAAU,KAAK,wBAAwB,SACzC,OAAO,KAAK,mBAAmB,IAC/B,KAAK,kBAAkB,IACrB,KAAK,MAAO,KAAK,kBAAkB,KAAK,kBAAmB,GAAG,IAC9D;AACN,kBAAQ,KAAK,kBAAkB,IAAI;AAAA,QACzC,CAAK;AACD,oBAAY,QAAQ;AAAA,MACrB,SAAQ,OAAO;AACdD,sBAAAA,MAAA,MAAA,SAAA,8CAAc,aAAa,KAAK;AAAA,MACjC;AAAA,IACH;AAEA,UAAM,qBAAqB,CAAC,cAAc;;AACxC,YAAM,UAAQ,iBAAY,UAAZ,mBAAoB,eAAc;AAChD,aAAO,KAAK,IAAI,KAAK,IAAI,OAAO,KAAK,GAAG,CAAC,GAAG,GAAG;AAAA,IACjD;AAEA,UAAM,iBAAiB,CAAC,YAAY;AAClC,aAAO,QAAQ,gBAAgB,QAAQ,gBAAgB,MAAM,QAAQ,EAAE;AAAA,IACzE;AAEA,UAAM,gBAAgB,YAAY;AAChC,UAAI,gBAAgB;AAAO;AAC3B,sBAAgB,QAAQ;AACxB,UAAI;AACF,cAAM,OAAO,MAAMC,cAAG,IAAC,WAAW;AAClC,cAAM,QAAQ,KAAK,YAAY,CAAE,GAAE,IAAIC,8BAAgB;AACvD,iBAAS,QAAQ;AAEjB,YAAI,CAAC,gBAAgB,SAAS,KAAK,QAAQ;AACzC,8BAAoB,KAAK,CAAC,CAAC;AAC3B;AAAA,QACD;AAED,YAAI,gBAAgB,OAAO;AACzB,gBAAM,UAAU,KAAK,KAAK,UAAQ,KAAK,OAAO,gBAAgB,MAAM,EAAE;AACtE,cAAI,SAAS;AACX,gCAAoB,OAAO;AAAA,UACnC,WAAiB,KAAK,QAAQ;AACtB,gCAAoB,KAAK,CAAC,CAAC;AAAA,UAC5B;AAAA,QACF;AAAA,MACF,SAAQ,OAAO;AACdF,sBAAAA,MAAA,MAAA,SAAA,8CAAc,WAAW,KAAK;AAC9BA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO,MAAM,WAAW;AAAA,UACxB,MAAM;AAAA,QACZ,CAAK;AAAA,MACL,UAAY;AACR,wBAAgB,QAAQ;AAAA,MACzB;AAAA,IACH;AAEA,UAAM,gBAAgB,YAAY;AAChC,UAAI,CAAC,sBAAqB,GAAI;AAC5B,iBAAS,QAAQ,CAAE;AACnB;AAAA,MACD;AACD,cAAQ,QAAQ;AAChB,UAAI;AACF,cAAM,WAAW,MAAMC,cAAAA,IAAI,aAAa,gBAAgB,MAAM,EAAE,WAAW;AAC3E,iBAAS,QAAQ,SAAS,YAAY,CAAE;AACxC,cAAM,cAAe;AAAA,MACtB,SAAQ,OAAO;AACdD,sBAAAA,MAAA,MAAA,SAAA,8CAAc,WAAW,KAAK;AAC9BA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO,MAAM,WAAW;AAAA,UACxB,MAAM;AAAA,QACZ,CAAK;AAAA,MACL,UAAY;AACR,gBAAQ,QAAQ;AAAA,MACjB;AAAA,IACH;AAEA,UAAM,oBAAoB,MAAM;AAC9B,UAAI,gBAAgB;AAAO;AAC3B,UAAI,CAAC,SAAS,MAAM,QAAQ;AAC1BA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,MAAM;AAAA,QACZ,CAAK;AACD;AAAA,MACD;AACDA,oBAAAA,MAAI,gBAAgB;AAAA,QAClB,UAAU,SAAS,MAAM,IAAI,UAAQ,KAAK,IAAI;AAAA,QAC9C,SAAS,OAAO,QAAQ;AACtB,gBAAM,UAAU,SAAS,MAAM,IAAI,QAAQ;AAC3C,cAAI,SAAS;AACX,gCAAoB,OAAO;AAC3B,kBAAM,cAAe;AAAA,UACtB;AAAA,QACF;AAAA,MACL,CAAG;AAAA,IACH;AAEA,UAAM,eAAe,CAAC,YAAY;;AAChC,YAAM,cAAY,qBAAgB,UAAhB,mBAAuB,OAAM;AAC/C,YAAM,gBAAc,qBAAgB,UAAhB,mBAAuB,SAAQ;AACnD,YAAM,cAAc,eAAe,OAAO;AAC1CA,oBAAAA,MAAI,WAAW;AAAA,QACb,KAAK,2CAA2C,SAAS,gBAAgB,mBAAmB,WAAW,CAAC,qBAAqB,QAAQ,EAAE,gBAAgB,mBAAmB,WAAW,CAAC;AAAA,MAC1L,CAAG;AAAA,IACH;AAEAG,kBAAAA,OAAO,YAAY;AACjB,4BAAuB;AACvB,YAAM,SAASJ,cAAc,eAAC,IAAK;AACnC,UAAI,QAAQ;AACV,wBAAgB,QAAQ;AAAA,MACzB;AACD,YAAM,cAAe;AACrB,YAAM,cAAe;AAAA,IACvB,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC/MD,GAAG,WAAW,eAAe;"}