{"version":3,"file":"wordPractice.js","sources":["stores/wordPractice.js"],"sourcesContent":["import { defineStore } from 'pinia'\r\nimport { fetchWordBooks, fetchWordBookWords } from '@/services/wordBooks.js'\r\nimport {\r\n  createEmptyProgress,\r\n  readBookProgress,\r\n  persistBookProgress,\r\n  updateWordStatus,\r\n  updateCursor\r\n} from '@/utils/wordProgress.js'\r\n\r\nconst LAST_BOOK_KEY = 'WORD_PRACTICE_LAST_BOOK'\r\n\r\nexport const useWordPracticeStore = defineStore('wordPractice', {\r\n  state: () => ({\r\n    books: [],\r\n    booksTotal: 0,\r\n    booksPagination: null,\r\n    booksLoading: false,\r\n    booksError: '',\r\n    wordsLoading: false,\r\n    wordsError: '',\r\n    wordsByBook: {},\r\n    selectedBookId: uni.getStorageSync(LAST_BOOK_KEY) || null,\r\n    currentWordIndex: 0,\r\n    progressByBook: {}\r\n  }),\r\n  getters: {\r\n    currentBook: (state) => state.books.find((book) => book.id === state.selectedBookId) || null,\r\n    currentWords: (state) => state.wordsByBook[state.selectedBookId] || [],\r\n    currentWord(state) {\r\n      const words = this.currentWords\r\n      if (!words.length) return null\r\n      const safeIndex = Math.min(Math.max(state.currentWordIndex, 0), words.length - 1)\r\n      return words[safeIndex] || null\r\n    },\r\n    currentProgress(state) {\r\n      return state.progressByBook[state.selectedBookId] || createEmptyProgress()\r\n    },\r\n    favorites() {\r\n      return this.currentProgress.favorites\r\n    },\r\n    mistakes() {\r\n      return this.currentProgress.mistakes\r\n    },\r\n    mastered() {\r\n      return this.currentProgress.mastered\r\n    },\r\n    learningRate() {\r\n      const total = this.currentWords.length || 1\r\n      return Math.round((this.mastered.length / total) * 100)\r\n    }\r\n  },\r\n  actions: {\r\n    async loadBooks(params = {}) {\r\n      this.booksLoading = true\r\n      this.booksError = ''\r\n      try {\r\n        const { books, total, pagination } = await fetchWordBooks(params)\r\n        this.books = books\r\n        this.booksTotal = total\r\n        this.booksPagination = pagination\r\n        if (this.selectedBookId && books.some((book) => book.id === this.selectedBookId)) {\r\n          this.bootstrapProgress(this.selectedBookId)\r\n        } else if (books.length) {\r\n          await this.selectBook(books[0].id, { preloadWords: false })\r\n        }\r\n      } catch (error) {\r\n        console.error('获取单词书列表失败', error)\r\n        this.booksError = error.message || '获取单词书失败'\r\n      } finally {\r\n        this.booksLoading = false\r\n      }\r\n    },\r\n    async selectBook(bookId, options = {}) {\r\n      const { preloadWords = true } = options\r\n      if (!bookId) return\r\n      const changed = this.selectedBookId !== bookId\r\n      this.selectedBookId = bookId\r\n      uni.setStorageSync(LAST_BOOK_KEY, bookId)\r\n      this.bootstrapProgress(bookId)\r\n      if (preloadWords && (changed || !this.wordsByBook[bookId])) {\r\n        await this.loadWords(bookId)\r\n      } else if (preloadWords) {\r\n        const progress = this.progressByBook[bookId]\r\n        this.currentWordIndex = progress?.lastCursor || 0\r\n      } else {\r\n        const progress = this.progressByBook[bookId]\r\n        this.currentWordIndex = progress?.lastCursor || 0\r\n      }\r\n    },\r\n    async loadWords(bookId) {\r\n      const targetId = bookId || this.selectedBookId\r\n      if (!targetId) return\r\n      this.wordsLoading = true\r\n      this.wordsError = ''\r\n      try {\r\n        const { words } = await fetchWordBookWords(targetId)\r\n        this.wordsByBook = {\r\n          ...this.wordsByBook,\r\n          [targetId]: words\r\n        }\r\n        this.bootstrapProgress(targetId)\r\n        const progress = this.progressByBook[targetId]\r\n        this.currentWordIndex = Math.min(progress.lastCursor || 0, Math.max(words.length - 1, 0))\r\n      } catch (error) {\r\n        console.error('加载单词列表失败', error)\r\n        this.wordsError = error.message || '加载单词失败'\r\n      } finally {\r\n        this.wordsLoading = false\r\n      }\r\n    },\r\n    bootstrapProgress(bookId) {\r\n      if (!bookId || this.progressByBook[bookId]) return\r\n      this.progressByBook = {\r\n        ...this.progressByBook,\r\n        [bookId]: readBookProgress(bookId)\r\n      }\r\n    },\r\n    persistProgress(bookId) {\r\n      const targetId = bookId || this.selectedBookId\r\n      const snapshot = this.progressByBook[targetId]\r\n      if (!targetId || !snapshot) return\r\n      persistBookProgress(targetId, snapshot)\r\n    },\r\n    setCurrentWordIndex(nextIndex) {\r\n      const words = this.currentWords\r\n      if (!words.length) return\r\n      const safeIndex = (nextIndex + words.length) % words.length\r\n      this.currentWordIndex = safeIndex\r\n      const snapshot = updateCursor(this.currentProgress, safeIndex)\r\n      this.progressByBook = {\r\n        ...this.progressByBook,\r\n        [this.selectedBookId]: snapshot\r\n      }\r\n      this.persistProgress(this.selectedBookId)\r\n    },\r\n    jumpToWord(wordId) {\r\n      const index = this.currentWords.findIndex((word) => word.id === wordId)\r\n      if (index !== -1) {\r\n        this.setCurrentWordIndex(index)\r\n      }\r\n    },\r\n    toggleFavorite(wordId) {\r\n      if (!this.currentWord) return\r\n      const snapshot = this.currentProgress\r\n      const isFavorite = snapshot.favorites.includes(wordId)\r\n      const bucket = isFavorite ? null : 'favorite'\r\n      this.applyWordStatus(wordId, bucket)\r\n    },\r\n    markMastered(wordId) {\r\n      this.applyWordStatus(wordId, 'mastered')\r\n    },\r\n    markMistake(wordId) {\r\n      this.applyWordStatus(wordId, 'mistake')\r\n    },\r\n    applyWordStatus(wordId, bucket) {\r\n      if (!this.selectedBookId || !wordId) return\r\n      let progress = this.currentProgress\r\n      if (bucket) {\r\n        progress = updateWordStatus(progress, wordId, bucket)\r\n      } else {\r\n        progress = updateWordStatus(progress, wordId)\r\n      }\r\n      this.progressByBook = {\r\n        ...this.progressByBook,\r\n        [this.selectedBookId]: progress\r\n      }\r\n      this.persistProgress(this.selectedBookId)\r\n    }\r\n  }\r\n})\r\n"],"names":["defineStore","uni","createEmptyProgress","fetchWordBooks","fetchWordBookWords","readBookProgress","persistBookProgress","updateCursor","updateWordStatus"],"mappings":"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"}