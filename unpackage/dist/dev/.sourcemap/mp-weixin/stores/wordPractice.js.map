{"version":3,"file":"wordPractice.js","sources":["stores/wordPractice.js"],"sourcesContent":["import { defineStore } from 'pinia'\nimport { fetchWordBooks, fetchWordBookWords } from '@/services/wordBooks.js'\nimport {\n  createEmptyProgress,\n  readBookProgress,\n  persistBookProgress,\n  updateWordStatus,\n  updateCursor\n} from '@/utils/wordProgress.js'\n\nconst LAST_BOOK_KEY = 'WORD_PRACTICE_LAST_BOOK'\n\nexport const useWordPracticeStore = defineStore('wordPractice', {\n  state: () => ({\n    books: [],\n    booksTotal: 0,\n    booksPagination: null,\n    booksLoading: false,\n    booksError: '',\n    wordsLoading: false,\n    wordsError: '',\n    wordsByBook: {},\n    selectedBookId: uni.getStorageSync(LAST_BOOK_KEY) || null,\n    currentWordIndex: 0,\n    progressByBook: {}\n  }),\n  getters: {\n    currentBook: (state) => state.books.find((book) => book.id === state.selectedBookId) || null,\n    currentWords: (state) => state.wordsByBook[state.selectedBookId] || [],\n    currentWord(state) {\n      const words = this.currentWords\n      if (!words.length) return null\n      const safeIndex = Math.min(Math.max(state.currentWordIndex, 0), words.length - 1)\n      return words[safeIndex] || null\n    },\n    currentProgress(state) {\n      return state.progressByBook[state.selectedBookId] || createEmptyProgress()\n    },\n    favorites() {\n      return this.currentProgress.favorites\n    },\n    mistakes() {\n      return this.currentProgress.mistakes\n    },\n    mastered() {\n      return this.currentProgress.mastered\n    },\n    learningRate() {\n      const total = this.currentWords.length || 1\n      return Math.round((this.mastered.length / total) * 100)\n    }\n  },\n  actions: {\n    async loadBooks(params = {}) {\n      this.booksLoading = true\n      this.booksError = ''\n      try {\n        const { books, total, pagination } = await fetchWordBooks(params)\n        this.books = books\n        this.booksTotal = total\n        this.booksPagination = pagination\n        if (this.selectedBookId && books.some((book) => book.id === this.selectedBookId)) {\n          this.bootstrapProgress(this.selectedBookId)\n        } else if (books.length) {\n          await this.selectBook(books[0].id, { preloadWords: false })\n        }\n      } catch (error) {\n        console.error('获取单词书列表失败', error)\n        this.booksError = error.message || '获取单词书失败'\n      } finally {\n        this.booksLoading = false\n      }\n    },\n    async selectBook(bookId, options = {}) {\n      const { preloadWords = true } = options\n      if (!bookId) return\n      const changed = this.selectedBookId !== bookId\n      this.selectedBookId = bookId\n      uni.setStorageSync(LAST_BOOK_KEY, bookId)\n      this.bootstrapProgress(bookId)\n      if (preloadWords && (changed || !this.wordsByBook[bookId])) {\n        await this.loadWords(bookId)\n      } else if (preloadWords) {\n        const progress = this.progressByBook[bookId]\n        this.currentWordIndex = progress?.lastCursor || 0\n      } else {\n        const progress = this.progressByBook[bookId]\n        this.currentWordIndex = progress?.lastCursor || 0\n      }\n    },\n    async loadWords(bookId) {\n      const targetId = bookId || this.selectedBookId\n      if (!targetId) return\n      this.wordsLoading = true\n      this.wordsError = ''\n      try {\n        const { words } = await fetchWordBookWords(targetId)\n        this.wordsByBook = {\n          ...this.wordsByBook,\n          [targetId]: words\n        }\n        this.bootstrapProgress(targetId)\n        const progress = this.progressByBook[targetId]\n        this.currentWordIndex = Math.min(progress.lastCursor || 0, Math.max(words.length - 1, 0))\n      } catch (error) {\n        console.error('加载单词列表失败', error)\n        this.wordsError = error.message || '加载单词失败'\n      } finally {\n        this.wordsLoading = false\n      }\n    },\n    bootstrapProgress(bookId) {\n      if (!bookId || this.progressByBook[bookId]) return\n      this.progressByBook = {\n        ...this.progressByBook,\n        [bookId]: readBookProgress(bookId)\n      }\n    },\n    persistProgress(bookId) {\n      const targetId = bookId || this.selectedBookId\n      const snapshot = this.progressByBook[targetId]\n      if (!targetId || !snapshot) return\n      persistBookProgress(targetId, snapshot)\n    },\n    setCurrentWordIndex(nextIndex) {\n      const words = this.currentWords\n      if (!words.length) return\n      const safeIndex = (nextIndex + words.length) % words.length\n      this.currentWordIndex = safeIndex\n      const snapshot = updateCursor(this.currentProgress, safeIndex)\n      this.progressByBook = {\n        ...this.progressByBook,\n        [this.selectedBookId]: snapshot\n      }\n      this.persistProgress(this.selectedBookId)\n    },\n    jumpToWord(wordId) {\n      const index = this.currentWords.findIndex((word) => word.id === wordId)\n      if (index !== -1) {\n        this.setCurrentWordIndex(index)\n      }\n    },\n    toggleFavorite(wordId) {\n      if (!this.currentWord) return\n      const snapshot = this.currentProgress\n      const isFavorite = snapshot.favorites.includes(wordId)\n      const bucket = isFavorite ? null : 'favorite'\n      this.applyWordStatus(wordId, bucket)\n    },\n    markMastered(wordId) {\n      this.applyWordStatus(wordId, 'mastered')\n    },\n    markMistake(wordId) {\n      this.applyWordStatus(wordId, 'mistake')\n    },\n    applyWordStatus(wordId, bucket) {\n      if (!this.selectedBookId || !wordId) return\n      let progress = this.currentProgress\n      if (bucket) {\n        progress = updateWordStatus(progress, wordId, bucket)\n      } else {\n        progress = updateWordStatus(progress, wordId)\n      }\n      this.progressByBook = {\n        ...this.progressByBook,\n        [this.selectedBookId]: progress\n      }\n      this.persistProgress(this.selectedBookId)\n    }\n  }\n})\n"],"names":["defineStore","uni","createEmptyProgress","fetchWordBooks","fetchWordBookWords","readBookProgress","persistBookProgress","updateCursor","updateWordStatus"],"mappings":"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"}