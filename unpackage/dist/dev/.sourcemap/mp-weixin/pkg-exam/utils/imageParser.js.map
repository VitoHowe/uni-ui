{"version":3,"file":"imageParser.js","sources":["pkg-exam/utils/imageParser.js"],"sourcesContent":["/**\n * 图片解析工具\n * 用于处理题目中的图片占位符 ${images/xxx.jpg}\n */\n\nimport MarkdownIt from 'markdown-it'\nimport katex from 'katex'\n\nconst markdown = new MarkdownIt({\n  html: true,\n  linkify: true,\n  breaks: true\n})\n\nconst ESCAPED_DOLLAR_TOKEN = '__WX_ESCAPED_DOLLAR__'\n\nconst replaceImagePlaceholders = (text, bankId, baseUrl) => {\n  return text.replace(/\\$\\{images\\/([^}]+)\\}/g, (match, filename) => {\n    const imageUrl = `${baseUrl}/api/question-banks/${bankId}/images/${filename}`\n    return `![image](${imageUrl})`\n  })\n}\n\nconst sanitizeRenderedHtml = (html) => {\n  if (!html) return ''\n  let output = html\n  output = output.replace(/<script[\\s\\S]*?>[\\s\\S]*?<\\/script>/gi, '')\n  output = output.replace(/<style[\\s\\S]*?>[\\s\\S]*?<\\/style>/gi, '')\n  output = output.replace(/<(iframe|object|embed)[\\s\\S]*?>[\\s\\S]*?<\\/\\1>/gi, '')\n  output = output.replace(/\\son\\w+=([\"']).*?\\1/gi, '')\n  output = output.replace(/\\son\\w+=\\S+/gi, '')\n  output = output.replace(/(href|src)=[\"']\\s*javascript:[^\"']*[\"']/gi, '$1=\"#\"')\n  return output\n}\n\nconst applyInlineStyle = (html, tagName, styleText) => {\n  const pattern = new RegExp(`<${tagName}([^>]*)>`, 'gi')\n  return html.replace(pattern, (match, attrs) => {\n    const attrText = attrs || ''\n    if (/style\\s*=/.test(attrText)) {\n      return `<${tagName}${attrText.replace(/style\\\\s*=\\\\s*([\"'])(.*?)\\\\1/i, (styleMatch, quote, styleValue) => {\n        const nextStyle = styleValue.trim().endsWith(';')\n          ? `${styleValue}${styleText}`\n          : `${styleValue};${styleText}`\n        return `style=${quote}${nextStyle}${quote}`\n      })}>`\n    }\n    return `<${tagName}${attrText} style=\"${styleText}\">`\n  })\n}\n\nconst enhanceImageLayout = (html) => {\n  if (!html) return ''\n  return applyInlineStyle(\n    html,\n    'img',\n    'max-width:100%;width:auto;height:auto;display:block;margin:12rpx auto;'\n  )\n}\n\nconst enhanceTableLayout = (html) => {\n  if (!html) return ''\n  return html.replace(/<table[\\s\\S]*?<\\/table>/gi, (tableHtml) => {\n    let enhanced = applyInlineStyle(\n      tableHtml,\n      'table',\n      'width:100%;border-collapse:collapse;table-layout:fixed;'\n    )\n    enhanced = applyInlineStyle(\n      enhanced,\n      'th',\n      'border:1px solid #e5e7eb;padding:6px 8px;font-weight:600;text-align:center;font-size:14px;line-height:1.5;word-break:break-word;'\n    )\n    enhanced = applyInlineStyle(\n      enhanced,\n      'td',\n      'border:1px solid #e5e7eb;padding:6px 8px;text-align:center;font-size:14px;line-height:1.5;word-break:break-word;'\n    )\n    return `<div style=\"max-width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;\">${enhanced}</div>`\n  })\n}\n\nconst tokenizeMathExpressions = (text) => {\n  const tokens = []\n  let working = text.replace(/\\\\\\$/g, ESCAPED_DOLLAR_TOKEN)\n\n  working = working.replace(/\\$\\$([\\s\\S]+?)\\$\\$/g, (match, formula) => {\n    const token = `@@MATH_BLOCK_${tokens.length}@@`\n    tokens.push({ token, formula, displayMode: true })\n    return token\n  })\n\n  working = working.replace(/\\$([^\\n$]+?)\\$/g, (match, formula) => {\n    const token = `@@MATH_INLINE_${tokens.length}@@`\n    tokens.push({ token, formula, displayMode: false })\n    return token\n  })\n\n  return { text: working, tokens }\n}\n\nconst restoreMathExpressions = (html, tokens) => {\n  let output = html\n  tokens.forEach(({ token, formula, displayMode }) => {\n    let rendered = ''\n    try {\n      rendered = katex.renderToString(formula.trim(), {\n        throwOnError: false,\n        displayMode,\n        strict: 'ignore'\n      })\n    } catch (error) {\n      rendered = formula\n    }\n    output = output.split(token).join(rendered)\n  })\n  return output.replace(new RegExp(ESCAPED_DOLLAR_TOKEN, 'g'), '$')\n}\n\n/**\n * 解析题目中的图片占位符，转换为HTML标签\n * @param {string} text - 原始文本内容\n * @param {number} bankId - 题库ID\n * @param {string} baseUrl - API基础URL（不包含/api）\n * @returns {string} 包含HTML标签的富文本\n */\nexport function parseQuestionImages(text, bankId, baseUrl = 'http://localhost:3001') {\n  if (!text) return ''\n\n  const withImages = replaceImagePlaceholders(text, bankId, baseUrl)\n  const { text: withTokens, tokens } = tokenizeMathExpressions(withImages)\n  const html = sanitizeRenderedHtml(markdown.render(withTokens))\n  const enhancedHtml = enhanceTableLayout(enhanceImageLayout(html))\n  return restoreMathExpressions(enhancedHtml, tokens)\n}\n\n/**\n * 提取文本中的所有图片URL（用于图片预览）\n * @param {string} text - 原始文本内容\n * @param {number} bankId - 题库ID\n * @param {string} baseUrl - API基础URL（不包含/api）\n * @returns {Array<string>} 图片URL数组\n */\nexport function extractImageUrls(text, bankId, baseUrl = 'http://localhost:3001') {\n  if (!text) return []\n  \n  const urls = []\n  const regex = /\\$\\{images\\/([^}]+)\\}/g\n  let match\n  \n  while ((match = regex.exec(text)) !== null) {\n    const filename = match[1]\n    urls.push(`${baseUrl}/api/question-banks/${bankId}/images/${filename}`)\n  }\n  \n  return urls\n}\n\n/**\n * 从多个文本字段中提取所有图片URL\n * @param {Object} question - 题目对象\n * @param {number} bankId - 题库ID\n * @param {string} baseUrl - API基础URL\n * @returns {Array<string>} 所有图片URL数组\n */\nexport function extractAllQuestionImages(question, bankId, baseUrl = 'http://localhost:3001') {\n  if (!question) return []\n  \n  const urls = []\n  \n  // 从题目内容中提取\n  if (question.content) {\n    urls.push(...extractImageUrls(question.content, bankId, baseUrl))\n  }\n  \n  // 从解析说明中提取\n  if (question.explanation) {\n    urls.push(...extractImageUrls(question.explanation, bankId, baseUrl))\n  }\n  \n  return urls\n}\n"],"names":["MarkdownIt","katex"],"mappings":"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"}