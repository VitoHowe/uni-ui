{"version":3,"file":"essay-detail.js","sources":["pkg-exam/pages/essay-detail/essay-detail.vue","../../../HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGtnLWV4YW1ccGFnZXNcZXNzYXktZGV0YWlsXGVzc2F5LWRldGFpbC52dWU"],"sourcesContent":["<template>\n  <view class=\"essay-detail-page\">\n    <view class=\"meta-card\" v-if=\"essayDetail\">\n      <text class=\"essay-title\">{{ essayDetail.title }}</text>\n      <view class=\"meta-row\">\n        <text class=\"meta-item\">机构：{{ essayDetail.org_name || '-' }}</text>\n        <text class=\"meta-item\">章节：{{ essayDetail.subject_chapter_name || '-' }}</text>\n      </view>\n      <text class=\"meta-time\">更新时间：{{ formatDate(essayDetail.updated_at) }}</text>\n    </view>\n\n    <view class=\"content-card\">\n      <view v-if=\"loading\" class=\"state-panel\">\n        <uni-icons type=\"spinner-cycle\" size=\"34\" color=\"#0f766e\" />\n        <text>正在加载论文内容...</text>\n      </view>\n\n      <view v-else-if=\"errorMessage\" class=\"state-panel error\">\n        <text>{{ errorMessage }}</text>\n        <button class=\"retry-btn\" @click=\"loadEssay\">重试</button>\n      </view>\n\n      <view v-else-if=\"!renderedContent\" class=\"state-panel\">\n        <text>论文内容为空</text>\n      </view>\n\n      <view v-else class=\"content-wrap\">\n        <view class=\"media-tools\">\n          <button v-if=\"previewImageUrls.length > 0\" class=\"media-preview-btn\" @click=\"previewImage()\">\n            点击放大图表（{{ previewImageUrls.length }}）\n          </button>\n          <view class=\"scale-tool\">\n            <text class=\"scale-label\">图表缩放：{{ Math.round(diagramScale * 100) }}%</text>\n            <text v-if=\"diagramScale > DEFAULT_DIAGRAM_SCALE\" class=\"scale-tip\">已启用横向滑动</text>\n            <view class=\"scale-actions\">\n              <button class=\"scale-btn\" @click=\"adjustDiagramScale(-DIAGRAM_SCALE_STEP)\">A-</button>\n              <button class=\"scale-btn\" @click=\"adjustDiagramScale(DIAGRAM_SCALE_STEP)\">A+</button>\n              <button class=\"scale-btn ghost\" @click=\"resetDiagramScale\">重置</button>\n            </view>\n          </view>\n        </view>\n        <rich-text class=\"essay-rich\" :nodes=\"renderedContent\" @itemclick=\"handleRichTextItemClick\"></rich-text>\n      </view>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { ref } from 'vue'\nimport { onLoad, onPullDownRefresh } from '@dcloudio/uni-app'\nimport { get } from '@/utils/request.js'\nimport { API_CONFIG, API_ENDPOINTS } from '@/utils/constants.js'\nimport { parseEssayMarkdown, extractEssayImageUrls } from '@/pkg-exam/utils/essayParser.js'\n\nconst essayId = ref(0)\nconst essayDetail = ref(null)\nconst markdownRaw = ref('')\nconst renderedContent = ref('')\nconst previewImageUrls = ref([])\nconst errorMessage = ref('')\nconst loading = ref(false)\nconst DEFAULT_DIAGRAM_SCALE = 1.3\nconst MIN_DIAGRAM_SCALE = 0.6\nconst MAX_DIAGRAM_SCALE = 2.4\nconst DIAGRAM_SCALE_STEP = 0.01\nconst diagramScale = ref(DEFAULT_DIAGRAM_SCALE)\n\nconst parseMarkdownResponse = (value) => {\n  if (typeof value === 'string') return value\n  if (value === null || value === undefined) return ''\n  if (typeof value === 'object') {\n    if (typeof value.content === 'string') return value.content\n    if (typeof value.data === 'string') return value.data\n    try {\n      return JSON.stringify(value)\n    } catch (error) {\n      return String(value)\n    }\n  }\n  return String(value)\n}\n\nconst resolveContentUrl = (contentUrl) => {\n  if (!contentUrl) return ''\n  if (/^https?:\\/\\//i.test(contentUrl)) return contentUrl\n  const origin = API_CONFIG.BASE_URL.replace(/\\/api\\/?$/, '')\n  return `${origin}${contentUrl.startsWith('/') ? '' : '/'}${contentUrl}`\n}\n\nconst resolveAssetUrl = (url) => {\n  const text = String(url || '').trim()\n  if (!text) return ''\n  if (/^https?:\\/\\//i.test(text)) return text\n  if (/^\\/\\//.test(text)) return `https:${text}`\n  if (/^data:/i.test(text)) return text\n  const origin = API_CONFIG.BASE_URL.replace(/\\/api\\/?$/, '')\n  return `${origin}${text.startsWith('/') ? '' : '/'}${text}`\n}\n\nconst requestMarkdown = (url) => {\n  return new Promise((resolve, reject) => {\n    uni.request({\n      url,\n      method: 'GET',\n      responseType: 'text',\n      success: (res) => {\n        if (res.statusCode >= 200 && res.statusCode < 300) {\n          resolve(parseMarkdownResponse(res.data))\n          return\n        }\n        reject(new Error(`论文内容加载失败（${res.statusCode}）`))\n      },\n      fail: (error) => {\n        reject(new Error(error.errMsg || '论文内容加载失败'))\n      }\n    })\n  })\n}\n\nconst renderMarkdown = () => {\n  if (!markdownRaw.value) {\n    renderedContent.value = ''\n    return\n  }\n  const allowHorizontalScroll = diagramScale.value > DEFAULT_DIAGRAM_SCALE\n  renderedContent.value = parseEssayMarkdown(markdownRaw.value, {\n    preFontScale: diagramScale.value,\n    tableFontScale: diagramScale.value,\n    allowHorizontalScroll\n  })\n}\n\nconst loadEssay = async () => {\n  if (!essayId.value) {\n    errorMessage.value = '缺少 essayId 参数'\n    return\n  }\n\n  loading.value = true\n  errorMessage.value = ''\n\n  try {\n    const detail = await get(API_ENDPOINTS.ESSAYS.DETAIL(essayId.value), {}, { showLoading: false })\n    essayDetail.value = detail\n\n    const fullContentUrl = resolveContentUrl(detail.content_url)\n    if (!fullContentUrl) {\n      throw new Error('论文内容地址无效')\n    }\n\n    const markdownText = await requestMarkdown(fullContentUrl)\n    markdownRaw.value = markdownText\n    const origin = API_CONFIG.BASE_URL.replace(/\\/api\\/?$/, '')\n    previewImageUrls.value = extractEssayImageUrls(markdownText, origin)\n    renderMarkdown()\n  } catch (error) {\n    console.error('加载论文失败:', error)\n    errorMessage.value = error.message || '加载论文失败'\n    markdownRaw.value = ''\n    renderedContent.value = ''\n    previewImageUrls.value = []\n  } finally {\n    loading.value = false\n  }\n}\n\nconst previewImage = (current = '') => {\n  if (!previewImageUrls.value.length) return\n  const currentUrl = current && previewImageUrls.value.includes(current)\n    ? current\n    : previewImageUrls.value[0]\n  uni.previewImage({\n    urls: previewImageUrls.value,\n    current: currentUrl\n  })\n}\n\nconst handleRichTextItemClick = (event) => {\n  const node = event?.detail?.node || event?.detail || {}\n  const nodeName = String(node?.name || '').toLowerCase()\n  if (nodeName !== 'img') return\n  const attrs = node?.attrs || {}\n  const src = attrs.src || attrs['data-src'] || ''\n  const resolvedSrc = resolveAssetUrl(src)\n  if (resolvedSrc) {\n    previewImage(resolvedSrc)\n  }\n}\n\nconst adjustDiagramScale = (step) => {\n  const nextScale = Number((diagramScale.value + step).toFixed(2))\n  diagramScale.value = Math.max(MIN_DIAGRAM_SCALE, Math.min(MAX_DIAGRAM_SCALE, nextScale))\n  renderMarkdown()\n}\n\nconst resetDiagramScale = () => {\n  diagramScale.value = DEFAULT_DIAGRAM_SCALE\n  renderMarkdown()\n}\n\nconst formatDate = (value) => {\n  if (!value) return '-'\n  const text = String(value)\n  if (text.length >= 16) {\n    return text.slice(0, 16).replace('T', ' ')\n  }\n  return text.replace('T', ' ')\n}\n\nonLoad((options) => {\n  essayId.value = Number(options.essayId || 0)\n  if (options.essayTitle) {\n    uni.setNavigationBarTitle({\n      title: decodeURIComponent(options.essayTitle)\n    })\n  }\n  loadEssay()\n})\n\nonPullDownRefresh(async () => {\n  await loadEssay()\n  uni.stopPullDownRefresh()\n})\n</script>\n\n<style scoped lang=\"scss\">\n.essay-detail-page {\n  min-height: 100vh;\n  padding: 24rpx;\n  background: linear-gradient(180deg, #ecfeff 0%, #f8fafc 40%, #f8fafc 100%);\n}\n\n.meta-card,\n.content-card {\n  border-radius: 20rpx;\n  background: #ffffff;\n  border: 1rpx solid #dbe7e4;\n  box-shadow: 0 10rpx 24rpx rgba(15, 23, 42, 0.06);\n}\n\n.meta-card {\n  padding: 24rpx;\n  margin-bottom: 16rpx;\n}\n\n.essay-title {\n  display: block;\n  font-size: 36rpx;\n  font-weight: 700;\n  color: #0f172a;\n  line-height: 1.45;\n}\n\n.meta-row {\n  margin-top: 12rpx;\n  display: flex;\n  flex-wrap: wrap;\n  gap: 14rpx;\n}\n\n.meta-item {\n  font-size: 24rpx;\n  color: #475569;\n}\n\n.meta-time {\n  margin-top: 8rpx;\n  display: block;\n  font-size: 22rpx;\n  color: #64748b;\n}\n\n.content-card {\n  padding: 16rpx;\n}\n\n.content-wrap {\n  padding: 8rpx;\n}\n\n.media-tools {\n  position: -webkit-sticky;\n  position: sticky;\n  top: 0;\n  z-index: 16;\n  display: flex;\n  flex-direction: column;\n  align-items: flex-end;\n  gap: 10rpx;\n  padding: 10rpx 0 8rpx;\n  margin-bottom: 12rpx;\n  background: rgba(255, 255, 255, 0.98);\n  border-bottom: 1rpx solid #eef2f7;\n}\n\n.media-preview-btn {\n  height: 56rpx;\n  line-height: 56rpx;\n  border-radius: 999rpx;\n  border: 1rpx solid #99f6e4;\n  padding: 0 20rpx;\n  background: #ecfeff;\n  color: #0f766e;\n  font-size: 22rpx;\n}\n\n.scale-tool {\n  display: flex;\n  align-items: center;\n  gap: 12rpx;\n  flex-wrap: wrap;\n  justify-content: flex-end;\n}\n\n.scale-label {\n  font-size: 22rpx;\n  color: #0f766e;\n}\n\n.scale-tip {\n  font-size: 20rpx;\n  color: #475569;\n}\n\n.scale-actions {\n  display: flex;\n  align-items: center;\n  gap: 8rpx;\n}\n\n.scale-btn {\n  min-width: 72rpx;\n  height: 48rpx;\n  line-height: 48rpx;\n  padding: 0 14rpx;\n  border-radius: 10rpx;\n  border: 1rpx solid #cbd5e1;\n  background: #ffffff;\n  color: #0f172a;\n  font-size: 22rpx;\n}\n\n.scale-btn.ghost {\n  min-width: 92rpx;\n  border-color: #99f6e4;\n  background: #ecfeff;\n  color: #0f766e;\n}\n\n.state-panel {\n  min-height: 320rpx;\n  border-radius: 16rpx;\n  background: #f8fafc;\n  color: #64748b;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  gap: 16rpx;\n  font-size: 26rpx;\n}\n\n.state-panel.error {\n  color: #dc2626;\n}\n\n.retry-btn {\n  min-width: 200rpx;\n  height: 74rpx;\n  border-radius: 14rpx;\n  background: #0f766e;\n  color: #ffffff;\n  border: none;\n  font-size: 26rpx;\n}\n\n.essay-rich {\n  font-size: 30rpx;\n  color: #1f2937;\n  line-height: 1.8;\n  word-break: break-word;\n  overflow-x: visible;\n}\n</style>\n","import MiniProgramPage from 'E:/personal/wx/uni-ui/pkg-exam/pages/essay-detail/essay-detail.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","API_CONFIG","uni","parseEssayMarkdown","get","API_ENDPOINTS","extractEssayImageUrls","onLoad","onPullDownRefresh"],"mappings":"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"}