{"version":3,"file":"essay-list.js","sources":["pkg-exam/pages/essay-list/essay-list.vue","../../../HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGtnLWV4YW1ccGFnZXNcZXNzYXktbGlzdFxlc3NheS1saXN0LnZ1ZQ"],"sourcesContent":["<template>\n  <view class=\"essay-list-page\">\n    <view class=\"subject-card\" @click=\"openSubjectPicker\">\n      <view class=\"subject-main\">\n        <text class=\"subject-label\">当前科目</text>\n        <text class=\"subject-name\">{{ selectedSubject?.name || '请选择科目' }}</text>\n      </view>\n      <view class=\"subject-action\">\n        <text>{{ subjects.length ? '切换' : '加载中' }}</text>\n        <uni-icons type=\"arrowdown\" size=\"16\" color=\"#0f766e\" />\n      </view>\n    </view>\n\n    <view class=\"org-card\">\n      <view class=\"section-head\">\n        <text class=\"section-title\">机构筛选</text>\n        <text class=\"section-hint\" v-if=\"selectedOrg\">已选：{{ selectedOrg.name }}</text>\n      </view>\n      <view v-if=\"loadingOrgs\" class=\"loading-row\">\n        <uni-icons type=\"spinner-cycle\" size=\"16\" color=\"#0f766e\" />\n        <text>正在加载机构...</text>\n      </view>\n      <view v-else-if=\"orgs.length === 0\" class=\"empty-row\">\n        <text>当前科目暂无论文机构</text>\n      </view>\n      <scroll-view v-else scroll-x class=\"org-scroll\" show-scrollbar=\"false\">\n        <view class=\"org-chip-row\">\n          <view\n            class=\"org-chip\"\n            :class=\"{ active: selectedOrgId === item.id }\"\n            v-for=\"item in orgs\"\n            :key=\"item.id\"\n            @click=\"selectOrg(item.id)\"\n          >\n            <text class=\"org-chip-name\">{{ item.name }}</text>\n            <text class=\"org-chip-count\">{{ item.essay_count || 0 }}</text>\n          </view>\n        </view>\n      </scroll-view>\n    </view>\n\n    <view class=\"list-card\">\n      <view class=\"section-head\">\n        <text class=\"section-title\">章节论文</text>\n        <text class=\"section-hint\" v-if=\"selectedOrg\">{{ selectedOrg.name }}</text>\n      </view>\n\n      <view v-if=\"loadingEssays\" class=\"loading-panel\">\n        <uni-icons type=\"spinner-cycle\" size=\"30\" color=\"#0f766e\" />\n        <text>加载章节论文中...</text>\n      </view>\n\n      <view v-else-if=\"chapterEssayGroups.length === 0\" class=\"empty-panel\">\n        <text>该机构在当前科目下暂无可学习论文</text>\n      </view>\n\n      <view v-else class=\"chapter-list\">\n        <view class=\"chapter-card\" v-for=\"group in chapterEssayGroups\" :key=\"group.chapter_id\">\n          <view class=\"chapter-head\">\n            <text class=\"chapter-name\">{{ group.chapter_name }}</text>\n            <text class=\"chapter-count\">{{ group.essays.length }} 篇</text>\n          </view>\n          <view\n            class=\"essay-item\"\n            v-for=\"essay in group.essays\"\n            :key=\"essay.id\"\n            @click=\"openEssayDetail(essay)\"\n          >\n            <view class=\"essay-main\">\n              <text class=\"essay-title\">{{ essay.title }}</text>\n              <text class=\"essay-meta\">更新时间：{{ formatDate(essay.updated_at) }}</text>\n            </view>\n            <uni-icons type=\"arrowright\" size=\"15\" color=\"#94a3b8\" />\n          </view>\n        </view>\n      </view>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { computed, ref } from 'vue'\nimport { onShow } from '@dcloudio/uni-app'\nimport { get } from '@/utils/request.js'\nimport { SubjectStorage, normalizeSubject } from '@/pkg-exam/utils/subject.js'\nimport { API_ENDPOINTS } from '@/utils/constants.js'\n\nconst subjects = ref([])\nconst selectedSubject = ref(SubjectStorage.get())\n\nconst orgs = ref([])\nconst selectedOrgId = ref(null)\n\nconst chapterEssayGroups = ref([])\n\nconst loadingOrgs = ref(false)\nconst loadingEssays = ref(false)\nconst loadingSubjects = ref(false)\n\nconst selectedOrg = computed(() => {\n  if (!selectedOrgId.value) return null\n  return orgs.value.find((item) => item.id === selectedOrgId.value) || null\n})\n\nconst ensureSubject = async () => {\n  if (!selectedSubject.value) {\n    await fetchSubjects()\n  }\n  return !!selectedSubject.value\n}\n\nconst syncSubject = (subject) => {\n  selectedSubject.value = subject\n  SubjectStorage.set(subject)\n}\n\nconst fetchSubjects = async () => {\n  if (loadingSubjects.value) return\n\n  loadingSubjects.value = true\n  try {\n    const data = await get(API_ENDPOINTS.SUBJECTS.LIST, {}, { showLoading: false })\n    const list = (data.subjects || []).map(normalizeSubject)\n    subjects.value = list\n\n    if (!selectedSubject.value && list.length > 0) {\n      syncSubject(list[0])\n      return\n    }\n\n    if (selectedSubject.value) {\n      const matched = list.find((item) => item.id === selectedSubject.value.id)\n      if (matched) {\n        syncSubject(matched)\n      } else if (list.length > 0) {\n        syncSubject(list[0])\n      } else {\n        syncSubject(null)\n      }\n    }\n  } catch (error) {\n    console.error('获取科目失败:', error)\n    uni.showToast({\n      title: error.message || '获取科目失败',\n      icon: 'none'\n    })\n  } finally {\n    loadingSubjects.value = false\n  }\n}\n\nconst fetchSubjectOrgs = async (subjectId) => {\n  const data = await get(API_ENDPOINTS.ESSAYS.SUBJECT_ORGS(subjectId), {}, { showLoading: false })\n  orgs.value = data.orgs || []\n\n  if (orgs.value.length === 0) {\n    selectedOrgId.value = null\n    chapterEssayGroups.value = []\n    return\n  }\n\n  const matched = orgs.value.find((item) => item.id === selectedOrgId.value)\n  selectedOrgId.value = matched ? matched.id : orgs.value[0].id\n}\n\nconst fetchChapterEssays = async () => {\n  if (!selectedSubject.value || !selectedOrgId.value) {\n    chapterEssayGroups.value = []\n    return\n  }\n\n  loadingEssays.value = true\n  try {\n    const subjectId = selectedSubject.value.id\n    const orgId = selectedOrgId.value\n    const data = await get(\n      API_ENDPOINTS.ESSAYS.SUBJECT_LIST(subjectId),\n      { orgId },\n      { showLoading: false }\n    )\n    const essays = data.essays || []\n    const groupedMap = new Map()\n\n    essays.forEach((essay) => {\n      const chapterId = Number(essay.subject_chapter_id) || 0\n      const chapterName = essay.subject_chapter_name || '未分类章节'\n      if (!groupedMap.has(chapterId)) {\n        groupedMap.set(chapterId, {\n          chapter_id: chapterId,\n          chapter_name: chapterName,\n          essays: []\n        })\n      }\n      groupedMap.get(chapterId).essays.push(essay)\n    })\n\n    chapterEssayGroups.value = Array.from(groupedMap.values())\n  } catch (error) {\n    console.error('加载机构论文失败:', error)\n    uni.showToast({\n      title: error.message || '加载论文失败',\n      icon: 'none'\n    })\n    chapterEssayGroups.value = []\n  } finally {\n    loadingEssays.value = false\n  }\n}\n\nconst loadAll = async () => {\n  const hasSubject = await ensureSubject()\n  if (!hasSubject) {\n    chapterEssayGroups.value = []\n    return\n  }\n\n  const subjectId = selectedSubject.value.id\n  loadingOrgs.value = true\n  try {\n    await fetchSubjectOrgs(subjectId)\n  } finally {\n    loadingOrgs.value = false\n  }\n\n  await fetchChapterEssays()\n}\n\nconst selectOrg = async (orgId) => {\n  if (selectedOrgId.value === orgId) return\n  selectedOrgId.value = orgId\n  await fetchChapterEssays()\n}\n\nconst openSubjectPicker = () => {\n  if (!subjects.value.length) {\n    uni.showToast({\n      title: '暂无可选科目',\n      icon: 'none'\n    })\n    return\n  }\n\n  uni.showActionSheet({\n    itemList: subjects.value.map((item) => item.name),\n    success: async (res) => {\n      const subject = subjects.value[res.tapIndex]\n      if (!subject) return\n      syncSubject(subject)\n      selectedOrgId.value = null\n      await loadAll()\n    }\n  })\n}\n\nconst openEssayDetail = (essay) => {\n  uni.navigateTo({\n    url: `/pkg-exam/pages/essay-detail/essay-detail?essayId=${essay.id}&essayTitle=${encodeURIComponent(essay.title)}`\n  })\n}\n\nconst formatDate = (value) => {\n  if (!value) return '-'\n  const text = String(value)\n  if (text.length >= 16) {\n    return text.slice(0, 16).replace('T', ' ')\n  }\n  return text.replace('T', ' ')\n}\n\nonShow(async () => {\n  const stored = SubjectStorage.get()\n  if (stored) {\n    selectedSubject.value = stored\n  }\n\n  await fetchSubjects()\n  await loadAll()\n})\n</script>\n\n<style scoped lang=\"scss\">\n.essay-list-page {\n  --essay-bg: #f8fafc;\n  --essay-surface: #ffffff;\n  --essay-text: #0f172a;\n  --essay-muted: #64748b;\n  --essay-primary: #0f766e;\n  --essay-border: #dbe7e4;\n  min-height: 100vh;\n  padding: 24rpx;\n  background: linear-gradient(180deg, #ecfeff 0%, #f8fafc 42%, #f8fafc 100%);\n}\n\n.subject-card,\n.org-card,\n.list-card {\n  border-radius: 20rpx;\n  background: var(--essay-surface);\n  border: 1rpx solid var(--essay-border);\n  box-shadow: 0 10rpx 24rpx rgba(15, 23, 42, 0.06);\n}\n\n.subject-card {\n  margin-bottom: 16rpx;\n  padding: 24rpx;\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n}\n\n.subject-main {\n  display: flex;\n  flex-direction: column;\n  gap: 6rpx;\n}\n\n.subject-label {\n  font-size: 24rpx;\n  color: var(--essay-muted);\n}\n\n.subject-name {\n  font-size: 34rpx;\n  font-weight: 700;\n  color: var(--essay-text);\n}\n\n.subject-action {\n  display: flex;\n  align-items: center;\n  gap: 8rpx;\n  font-size: 24rpx;\n  color: var(--essay-primary);\n  font-weight: 600;\n}\n\n.org-card,\n.list-card {\n  padding: 22rpx;\n  margin-bottom: 16rpx;\n}\n\n.section-head {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-bottom: 14rpx;\n}\n\n.section-title {\n  font-size: 30rpx;\n  font-weight: 700;\n  color: var(--essay-text);\n}\n\n.section-hint {\n  font-size: 24rpx;\n  color: var(--essay-muted);\n}\n\n.loading-row,\n.empty-row {\n  min-height: 72rpx;\n  border-radius: 14rpx;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  gap: 8rpx;\n  background: #f8fafc;\n  color: var(--essay-muted);\n  font-size: 24rpx;\n}\n\n.org-scroll {\n  width: 100%;\n  white-space: nowrap;\n}\n\n.org-chip-row {\n  display: inline-flex;\n  gap: 10rpx;\n}\n\n.org-chip {\n  display: inline-flex;\n  align-items: center;\n  gap: 10rpx;\n  padding: 12rpx 16rpx;\n  border-radius: 999rpx;\n  border: 1rpx solid #cbd5e1;\n  background: #f8fafc;\n}\n\n.org-chip.active {\n  background: #0f766e;\n  border-color: #0f766e;\n}\n\n.org-chip-name {\n  font-size: 24rpx;\n  color: #0f172a;\n  font-weight: 600;\n}\n\n.org-chip.active .org-chip-name {\n  color: #f8fafc;\n}\n\n.org-chip-count {\n  min-width: 34rpx;\n  height: 34rpx;\n  border-radius: 999rpx;\n  background: rgba(15, 118, 110, 0.14);\n  color: #0f766e;\n  font-size: 20rpx;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  padding: 0 8rpx;\n}\n\n.org-chip.active .org-chip-count {\n  color: #0f172a;\n  background: #f8fafc;\n}\n\n.loading-panel,\n.empty-panel {\n  min-height: 240rpx;\n  border-radius: 16rpx;\n  background: #f8fafc;\n  color: var(--essay-muted);\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  gap: 12rpx;\n  font-size: 25rpx;\n}\n\n.chapter-list {\n  display: flex;\n  flex-direction: column;\n  gap: 14rpx;\n}\n\n.chapter-card {\n  border-radius: 16rpx;\n  border: 1rpx solid #e2e8f0;\n  background: #ffffff;\n  overflow: hidden;\n}\n\n.chapter-head {\n  padding: 16rpx 18rpx;\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  background: #f8fafc;\n  border-bottom: 1rpx solid #e2e8f0;\n}\n\n.chapter-name {\n  font-size: 27rpx;\n  font-weight: 700;\n  color: #0f172a;\n}\n\n.chapter-count {\n  font-size: 22rpx;\n  color: #475569;\n}\n\n.essay-item {\n  padding: 16rpx 18rpx;\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  gap: 14rpx;\n  border-top: 1rpx solid #f1f5f9;\n}\n\n.essay-item:first-child {\n  border-top: none;\n}\n\n.essay-main {\n  flex: 1;\n}\n\n.essay-title {\n  display: block;\n  font-size: 27rpx;\n  color: #0f172a;\n  font-weight: 600;\n}\n\n.essay-meta {\n  display: block;\n  margin-top: 4rpx;\n  font-size: 22rpx;\n  color: #64748b;\n}\n</style>\r\n","import MiniProgramPage from 'E:/personal/wx/uni-ui/pkg-exam/pages/essay-list/essay-list.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","SubjectStorage","computed","get","API_ENDPOINTS","normalizeSubject","uni","onShow"],"mappings":"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"}